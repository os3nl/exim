====== MTA1 Template ======

=== Q1. As per usual explain everything you have done in your log and how  ===

The code can be found [[https://github.com/os3nl/exim|here]]

== a. First make sure that your system does not contain a pre-installed version of the MTA of your choice if so remove it before you continue  == 
<code>
RUN (which exim && echo exim found && exit 1) || true
</code>
== b. Make sure the source code is retrieved from a secure location Use the official website for the MTA of your choice  == 
<code>
ARG EXIM_VERSION=4.91
ARG EXIM_URL=ftp://mirror.easyname.at/exim-ftp/exim/exim4/exim-$EXIM_VERSION.tar.gz
RUN wget -O /tmp/exim.tgz $EXIM_URL
# which is from the first source found at https://www.exim.org/mirmon/ftp_mirrors.html
</code>
== c. Because it is important that an MTA be correct and secure it is often signed using a digital PGP signature If your MTA is signed then make sure Within reason please do not email the authors you have downloaded the correct sources by checking the validity of the key and the signature  == 
<code>
RUN wget -O /tmp/exim.asc $EXIM_URL.asc
# which is signed by 'the file nigel-pubkey.asc'
# src: https://www.exim.org/exim-html-current/doc/html/spec_html/ch-introduction.html
ARG KEYFILEURL=ftp://mirror.easyname.at/exim-ftp/exim/nigel-pubkey.asc
RUN wget -O /tmp/key $KEYFILEURL
RUN gpg --import /tmp/key
# But this failed:
# gpg: Signature made Sun Apr 15 13:23:10 2018 UTC
# gpg:                using RSA key BCE58C8CE41F32DF
# gpg: Can't check signature: No public key
# So we read further at the source above:
# At time of last update, releases were being made by Jeremy Harris
# and signed with key 0xBCE58C8CE41F32DF.
# Other recent keys used for signing are those of Heiko Schlittermann,
# 0x26101B62F69376CE, and of Phil Pennock, 0x4D1E900E14C1CC04.
ARG KEYSURL=ftp://mirror.easyname.at/exim-ftp/exim/Exim-Maintainers-Keyring.asc
ARG KEYSURL=http://exim.mirror.colo-serv.net/exim/Exim-Maintainers-Keyring.asc
RUN wget -O /tmp/keys $KEYSURL
RUN gpg --import /tmp/keys
RUN gpg --verify /tmp/exim.asc /tmp/exim.tgz
</code>

which outputs:
<code>
Step 15/15 : RUN gpg --verify /tmp/exim.asc /tmp/exim.tgz
 ---> Running in ebd8d8829baa
gpg: Signature made Sun Apr 15 13:23:10 2018 UTC
gpg:                using RSA key BCE58C8CE41F32DF
gpg: Good signature from "Jeremy Harris (none) <jgh@wizmail.org>" [unknown]
gpg:                 aka "Jeremy Harris <jgh@redhat.com>" [unknown]
gpg: WARNING: This key is not certified with a trusted signature!
gpg:          There is no indication that the signature belongs to the owner.
Primary key fingerprint: A986 F3A6 BD63 77D8 7309  58DE BCE5 8C8C E41F 32DF
</code>
== d. There are a number of options that you will have to enter before compilation so that the functionality can be compiled into the program Make sure the basic install holds all the necessary functionality Show the options you configured  == 
<code>
ARG ALPINEMAKE=https://git.alpinelinux.org/cgit/aports/plain/community/exim/exim.Makefile
RUN wget -O /tmp/exim/Local/Makefile $ALPINEMAKE
RUN sed -i -e 's/-lnsl//g' -e 's/^HAVE_ICONV.*$//' \
  /tmp/exim/OS/Makefile-Linux
</code>

The options used:
<code>
curl --silent \
  https://git.alpinelinux.org/cgit/aports/plain/community/exim/exim.Makefile \
  | sed -e 's/-lnsl//g' -e 's/^HAVE_ICONV.*$//'           
AUTH_CRAM_MD5=yes
AUTH_DOVECOT=yes
AUTH_PLAINTEXT=yes
AUTH_SPA=yes
AUTH_TLS=yes
BIN_DIRECTORY=/usr/sbin
CFLAGS_DYNAMIC=-shared -rdynamic -fPIC
COMPRESS_COMMAND=/bin/gzip
COMPRESS_SUFFIX=gz
CONFIGURE_FILE=/etc/exim/exim.conf
CONFIGURE_FILE_USE_EUID=yes
CONFIGURE_FILE_USE_NODE=yes
EXICYCLOG_MAX=10
EXIM_USER=ref:exim
EXPAND_DLFUNC=yes
EXPERIMENTAL_CERTNAMES=yes
EXPERIMENTAL_EVENT=yes
EXPERIMENTAL_INTERNATIONAL=yes
EXPERIMENTAL_SOCKS=yes
EXPERIMENTAL_SPF=yes
EXTRALIBS_EXIM=-export-dynamic -rdynamic -ldl
FIXED_NEVER_USERS=root
HAVE_IPV6=YES
HEADERS_CHARSET="ISO-8859-1"
LDFLAGS += -lidn
LDFLAGS += -lspf2
LOG_FILE_PATH=/var/log/exim/%slog
LOOKUP_CDB=2
LOOKUP_DBM=2
LOOKUP_DNSDB=2
LOOKUP_DSEARCH=yes
LOOKUP_LSEARCH=yes
LOOKUP_MODULE_DIR=/usr/lib/exim/
LOOKUP_MYSQL=2
LOOKUP_MYSQL_INCLUDE=-I/usr/include/mysql
LOOKUP_MYSQL_LIBS=-Wl,--no-as-needed -lmysqlclient
LOOKUP_PASSWD=yes
LOOKUP_PGSQL=2
LOOKUP_PGSQL_INCLUDE=-I/usr/include/postgresql
LOOKUP_PGSQL_LIBS=-Wl,--no-as-needed -lpq
LOOKUP_SQLITE=2
LOOKUP_SQLITE_LIBS=-Wl,--no-as-needed -lsqlite3
MAKE_SHELL=/bin/bash
NO_SYMLINK=yes
PCRE_CONFIG=yes
PCRE_LIBS=-lpcre
PID_FILE_PATH=/run/exim.pid
ROUTER_ACCEPT=yes
ROUTER_DNSLOOKUP=yes
ROUTER_IPLITERAL=yes
ROUTER_IPLOOKUP=yes
ROUTER_MANUALROUTE=yes
ROUTER_QUERYPROGRAM=yes
ROUTER_REDIRECT=yes
SPOOL_DIRECTORY=/var/spool/exim
SUPPORT_CRYPTEQ=yes
SUPPORT_MAILDIR=yes
SUPPORT_MOVE_FROZEN_MESSAGES=yes
SUPPORT_PROXY=yes
SUPPORT_TLS=yes
SYSLOG_LOG_PID=no
SYSTEM_ALIASES_FILE=/etc/mail/aliases
TMPDIR="/tmp"
TRANSPORT_APPENDFILE=yes
TRANSPORT_AUTOREPLY=yes
TRANSPORT_LMTP=yes
TRANSPORT_PIPE=yes
TRANSPORT_SMTP=yes
USE_OPENSSL_PC=openssl
WITH_CONTENT_SCAN=yes
WITH_OLD_DEMIME=yes
ZCAT_COMMAND=
</code>

Installing
<code>
RUN make Makefile
RUN make -j1
RUN make INSTALL_ARG="exim_dbmbuild exim_dumpdb exim_tidydb exim_fixdb exim_lock" install
RUN adduser -D exim
RUN make INSTALL_ARG="exim" install
# Since we have two, we symlink (/usr/sbin/exim-4.91-6  /usr/sbin/exim-4.91-8)
RUN ln -s `ls /usr/sbin/exim-*|tail -1` /usr/sbin/exim
ENTRYPOINT ["/usr/sbin/exim"]
</code>

The adduser was needed since we got:
<code>
*** Could not run ./exim -bV -C /dev/null to find version number ***
*** Exim installation failed ***
exim: failed to find uid for user name "exim"
make: *** [Makefile:85: install] Error 1
</code>

After the installation we
[[https://www.exim.org/exim-html-current/doc/html/spec_html/ch-building_and_installing_exim.html|test]] (ch.19):
<code>
docker run -it --rm exim -bV
Exim version 4.91 #6 built 05-Oct-2018 13:04:27
Copyright (c) University of Cambridge, 1995 - 2018
(c) The Exim Maintainers and contributors in ACKNOWLEDGMENTS file, 2007 - 2018
Berkeley DB: Berkeley DB 5.3.28: (September  9, 2013)
Support for: crypteq IPv6 Expand_dlfunc OpenSSL move_frozen_messages Content_Scanning DKIM DNSSEC Event OCSP PRDR PROXY TCP_Fast_Open
Lookups (built-in): lsearch wildlsearch nwildlsearch iplsearch dsearch passwd
Authenticators: cram_md5 dovecot plaintext spa tls
Routers: accept dnslookup ipliteral iplookup manualroute queryprogram redirect
Transports: appendfile/maildir autoreply lmtp pipe smtp
Malware: f-protd f-prot6d drweb aveserver fsecure kavdaemon sophie clamd mksd avast sock cmdline
Fixed never_users: 0
Configure owner: 0:0
Size of off_t: 8
2018-10-05 13:17:32 Couldn't open /usr/lib/exim/: not loading lookup modules

2018-10-05 13:17:32 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-05 13:17:32 Warning: purging the environment.
 Suggested action: use keep_environment.
Configuration file is /etc/exim/exim.conf
</code>

=== Q2. Most of the options for an MTA can be found in a configuration file that will be loaded when the MTA starts It is recommended to start with an example configuration that looks a lot like what you need for now Show how you adapt it to your needs  ===

I retrieved the default config by doing
<code>
docker run -it --rm exim cat /etc/exim/exim.conf > exim.conf
</code>

But this was very large,
online they suggested:
<code>
apt update
apt install -y exim4-config 
dpkg-reconfigure exim4-config
</code>

Generating the config:
<code>
root@8b810ce9eb73:/# dpkg-reconfigure exim4-config
debconf: unable to initialize frontend: Dialog
debconf: (No usable dialog-like program is installed, so the dialog based frontend cannot be used. at /usr/share/perl5/Debconf/FrontEnd/Dialog.pm line 76.)
debconf: falling back to frontend: Readline
debconf: unable to initialize frontend: Readline
debconf: (Can't locate Term/ReadLine.pm in @INC (you may need to install the Term::ReadLine module) (@INC contains: /etc/perl /usr/local/lib/x86_64-linux-gnu/perl/5.24.1 /usr/local/share/perl/5.24.1 /usr/lib/x86_64-linux-gnu/perl5/5.24 /usr/share/perl5 /usr/lib/x86_64-linux-gnu/perl/5.24 /usr/share/perl/5.24 /usr/local/lib/site_perl /usr/lib/x86_64-linux-gnu/perl-base .) at /usr/share/perl5/Debconf/FrontEnd/Readline.pm line 7.)
debconf: falling back to frontend: Teletype
Mail Server configuration
-------------------------

Please select the mail server configuration type that best meets your needs.

Systems with dynamic IP addresses, including dialup systems, should generally be configured to
send outgoing mail to another machine, called a 'smarthost' for delivery because many receiving
systems on the Internet block incoming mail from dynamic IP addresses as spam protection.

A system with a dynamic IP address can receive its own mail, or local delivery can be disabled
entirely (except mail for root and postmaster).

  1. internet site; mail is sent and received directly using SMTP
  2. mail sent by smarthost; received via SMTP or fetchmail
  3. mail sent by smarthost; no local mail
  4. local delivery only; not on a network
  5. no configuration at this time
General type of mail configuration: 1

The 'mail name' is the domain name used to 'qualify' mail addresses without a domain name.

This name will also be used by other programs. It should be the single, fully qualified domain
name (FQDN).

Thus, if a mail address on the local host is foo@example.org, the correct value for this option
would be example.org.

This name won't appear on From: lines of outgoing messages if rewriting is enabled.

System mail name: nevers.studlab.os3.nl

Please enter a semicolon-separated list of IP addresses. The Exim SMTP listener daemon will
listen on all IP addresses listed here.

An empty value will cause Exim to listen for connections on all available network interfaces.

If this system only receives mail directly from local services (and not from other hosts), it is
suggested to prohibit external connections to the local Exim daemon. Such services include
e-mail programs (MUAs) which talk to localhost only as well as fetchmail. External connections
are impossible when 127.0.0.1 is entered here, as this will disable listening on public network
interfaces.

IP-addresses to listen on for incoming SMTP connections: 

Please enter a semicolon-separated list of recipient domains for which this machine should
consider itself the final destination. These domains are commonly called 'local domains'. The
local hostname (8b810ce9eb73) and 'localhost' are always added to the list given here.

By default all local domains will be treated identically. If both a.example and b.example are
local domains, acc@a.example and acc@b.example will be delivered to the same final destination.
If different domain names should be treated differently, it is necessary to edit the config
files afterwards.

Other destinations for which mail is accepted: 

Please enter a semicolon-separated list of recipient domains for which this system will relay
mail, for example as a fallback MX or mail gateway. This means that this system will accept mail
for these domains from anywhere on the Internet and deliver them according to local delivery
rules.

Do not mention local domains here. Wildcards may be used.

Domains to relay mail for: hull.studlab.os3.nl : mulhouse.studlab.os3.nl

Please enter a semicolon-separated list of IP address ranges for which this system will
unconditionally relay mail, functioning as a smarthost.

You should use the standard address/prefix format (e.g. 194.222.242.0/24 or
5f03:1200:836f::/48).

If this system should not be a smarthost for any other host, leave this list blank.

Machines to relay mail for: 172.16.0.0/12

In normal mode of operation Exim does DNS lookups at startup, and when receiving or delivering
messages. This is for logging purposes and allows keeping down the number of hard-coded values
in the configuration.

If this system does not have a DNS full service resolver available at all times (for example if
its Internet access is a dial-up line using dial-on-demand), this might have unwanted
consequences. For example, starting up Exim or running the queue (even with no messages waiting)
might trigger a costly dial-up-event.

This option should be selected if this system is using Dial-on-Demand. If it has always-on
Internet access, this option should be disabled.

Keep number of DNS-queries minimal (Dial-on-Demand)? [yes/no] no

Exim is able to store locally delivered email in different formats. The most commonly used ones
are mbox and Maildir. mbox uses a single file for the complete mail folder stored in /var/mail/.
With Maildir format every single message is stored in a separate file in ~/Maildir/.

Please note that most mail tools in Debian expect the local delivery method to be mbox in their
default.

  1. mbox format in /var/mail/  2. Maildir format in home directory
Delivery method for local mail: 2

The Debian exim4 packages can either use 'unsplit configuration', a single monolithic file
(/etc/exim4/exim4.conf.template) or 'split configuration', where the actual Exim configuration
files are built from about 50 smaller files in /etc/exim4/conf.d/.

Unsplit configuration is better suited for large modifications and is generally more stable,
whereas split configuration offers a comfortable way to make smaller modifications but is more
fragile and might break if modified carelessly.

A more detailed discussion of split and unsplit configuration can be found in the
Debian-specific README files in /usr/share/doc/exim4-base.

Split configuration into small files? [yes/no] no

Mail for the 'postmaster', 'root', and other system accounts needs to be redirected to the user
account of the actual system administrator.

If this value is left empty, such mail will be saved in /var/mail/mail, which is not
recommended.

Note that postmaster's mail should be read on the system to which it is directed, rather than
being forwarded elsewhere, so (at least one of) the users listed here should not redirect their
mail off this machine. A 'real-' prefix can be used to force local delivery.

Multiple user names need to be separated by spaces.

Root and postmaster mail recipient: os3student

</code>

Which generated:
<code>
root@8b810ce9eb73:/etc/exim4# grep -r os3 / 2> /dev/null                                         
/etc/resolv.conf:search studlab.os3.nl
/etc/mailname:nevers.studlab.os3.nl
/etc/exim4/update-exim4.conf.conf:dc_relay_domains='hull.studlab.os3.nl : mulhouse.studlab.os3.nl'
/etc/aliases:root: os3student
/proc/kallsyms:0000000000000000 t dmi_smbios3_present
^C
root@8b810ce9eb73:/etc/exim4# cat /etc/mailname 
nevers.studlab.os3.nl
root@8b810ce9eb73:/etc/exim4# cat /etc/aliases 
# /etc/aliases
mailer-daemon: postmaster
postmaster: root
nobody: root
hostmaster: root
usenet: root
news: root
webmaster: root
www: root
ftp: root
abuse: root
noc: root
security: root
root: os3student
root@8b810ce9eb73:/etc/exim4# cat /etc/exim4/update-exim4.conf.conf 
# /etc/exim4/update-exim4.conf.conf
#
# Edit this file and /etc/mailname by hand and execute update-exim4.conf
# yourself or use 'dpkg-reconfigure exim4-config'
#
# Please note that this is _not_ a dpkg-conffile and that automatic changes
# to this file might happen. The code handling this will honor your local
# changes, so this is usually fine, but will break local schemes that mess
# around with multiple versions of the file.
#
# update-exim4.conf uses this file to determine variable values to generate
# exim configuration macros for the configuration file.
#
# Most settings found in here do have corresponding questions in the
# Debconf configuration, but not all of them.
#
# This is a Debian specific file

dc_eximconfig_configtype='internet'
dc_other_hostnames=''
dc_local_interfaces=''
dc_readhost=''
dc_relay_domains='hull.studlab.os3.nl : mulhouse.studlab.os3.nl'
dc_minimaldns='false'
dc_relay_nets='172.16.0.0/12'
dc_smarthost=''
CFILEMODE='644'
dc_use_split_config='false'
dc_hide_mailname=''
dc_mailname_in_oh='true'
dc_localdelivery='maildir_home'
</code>
This
[[http://www.learnlinux.org.za/courses/build/electives/ch04s02.html|three files]]
contain the config.

We saw in the
[[buildlog|https://hub.docker.com/r/os3nl/exim/builds/bwmxkpc8jxznyluabhnazxs/]]:
<code>
cp: can't create '/etc/mail/aliases': No such file or directory
</code>

=== Q3.  ===
== a. Add a local account on your experimental machine and make sure that the MTA can deliver mail to it Show the required configuration  == 
== b. Add to your log an email received by this account Do not forget the full headers  == 
== c. Also make sure that any email intended for postmaster city prac os3 nl is delivered to this account Show the full email as delivered to the new account and the required configuration  == 

=== Q4. First describe you have done on your own server to create two backup MTAs for your domain Please do not describe how you made your server fallback for the other domains at the same time that is the next question This makes grading easier for the lab teachers  ===

=== Q5. Afterwards describe what you have done on your own server to make it act as a backup for the two other domains  ===

=== Q6. Shutdown your MTA send a mail to your domain and show  ===
== a. The email is delivered to one of your colleaques  == 
== b. The email is delivered to your MTA when you turn it back on  == 

=== Q7. Choose a console mail client that is available in the Ubuntu repositories install it and configure it to read mail for the account added before  ===
== a. Where does the client store read emails?  == 
== b. In what format?  == 

=== Q8. Briefly explain  ===
== a. what mail queues your mail server uses  == 
== b. what is their purpose  == 
== c. where are they located on your machine and  == 
== d. how can you interact with them?  == 