====== MTA2 Template ======
https://www.os3.nl/2018-2019/courses/cia/labs/templ/mta2

=== Q1. Now send an email to the loop using your own email address and show what happens on your MTA (logs error message)  ===

For both my mailservers:
<code>
grep loop\@ *
aliases:loop: loop@secondary.nevers.prac.os3.nl
aliases2:loop: loop@nevers.prac.os3.nl
</code>

After no wild loops, I started debugging:
<code>
exim -bt -d-resolver loop@nevers.prac.os3.nl
Exim version 4.91 uid=0 gid=0 pid=31 D=fbb95cfd
Support for: crypteq IPv6 Expand_dlfunc OpenSSL move_frozen_messages Content_Scanning DKIM DNSSEC Event OCSP PRDR TCP_Fast_Open
Lookups (built-in): lsearch wildlsearch nwildlsearch iplsearch dsearch passwd
Authenticators: cram_md5 dovecot plaintext spa tls
Routers: accept dnslookup ipliteral iplookup manualroute queryprogram redirect
Transports: appendfile/maildir autoreply lmtp pipe smtp
Malware: f-protd f-prot6d drweb aveserver fsecure kavdaemon sophie clamd mksd avast sock cmdline
Fixed never_users: 0
Configure owner: 0:0
Size of off_t: 8
Compiler: GCC [6.4.0]
Library version: BDB: Compile: Berkeley DB 5.3.28: (September  9, 2013)
                      Runtime: Berkeley DB 5.3.28: (September  9, 2013)
Library version: OpenSSL: Compile: LibreSSL 2.7.4
                          Runtime: LibreSSL 2.7.4
                                 : built on: date not available
Library version: PCRE: Compile: 8.42
                       Runtime: 8.42 2018-03-20
Loading lookup modules from /usr/lib/exim/
Loaded 0 lookup modules
Total 6 lookups
WHITELIST_D_MACROS unset
TRUSTED_CONFIG_LIST unset
changed uid/gid: forcing real = effective
  uid=0 gid=0 pid=31
  auxiliary group list: <none>
changed uid/gid: calling tls_validate_require_cipher
  uid=100 gid=101 pid=32
  auxiliary group list: <none>
tls_validate_require_cipher child 32 ended: status=0x0
configuration file is /etc/exim/exim.conf
log selectors = 0000cffc 63201022 00000000
trusted user
admin user
originator: uid=0 gid=0 login=root name=root
sender address = root@secondary.nevers.prac.os3.nl
Address testing: uid=0 gid=101 euid=0 egid=101
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Testing loop@nevers.prac.os3.nl
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Considering loop@nevers.prac.os3.nl
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
routing loop@nevers.prac.os3.nl
--------> dnslookup router <--------
local_part=loop domain=nevers.prac.os3.nl
checking domains
nevers.prac.os3.nl in "secondary.nevers.prac.os3.nl"? no (end of list)
nevers.prac.os3.nl in "! +local_domains"? yes (end of list)
calling dnslookup router
dnslookup router called for loop@nevers.prac.os3.nl
  domain = nevers.prac.os3.nl
DNS lookup of nevers.prac.os3.nl (MX) succeeded
dnslookup router: defer for loop@nevers.prac.os3.nl
  message: host lookup did not complete
loop@nevers.prac.os3.nl cannot be resolved at this time: host lookup did not complete
search_tidyup called
>>>>>>>>>>>>>>>> Exim pid=31 (main) terminating with rc=1 >>>>>>>>>>>>>>>>
</code>

Which was fixed by this line:
<code>
root@nevers:/home/slentink# grep 145 /etc/systemd/resolved.conf 
DNS=145.100.104.117
</code>

after which we got:
<code>
/ # exim -bt -d-resolver loop@nevers.prac.os3.nl
Exim version 4.91 uid=0 gid=0 pid=109 D=fbb95cfd
Support for: crypteq IPv6 Expand_dlfunc OpenSSL move_frozen_messages Content_Scanning DKIM DNSSEC Event OCSP PRDR TCP_Fast_Open
Lookups (built-in): lsearch wildlsearch nwildlsearch iplsearch dsearch passwd
Authenticators: cram_md5 dovecot plaintext spa tls
Routers: accept dnslookup ipliteral iplookup manualroute queryprogram redirect
Transports: appendfile/maildir autoreply lmtp pipe smtp
Malware: f-protd f-prot6d drweb aveserver fsecure kavdaemon sophie clamd mksd avast sock cmdline
Fixed never_users: 0
Configure owner: 0:0
Size of off_t: 8
Compiler: GCC [6.4.0]
Library version: BDB: Compile: Berkeley DB 5.3.28: (September  9, 2013)
                      Runtime: Berkeley DB 5.3.28: (September  9, 2013)
Library version: OpenSSL: Compile: LibreSSL 2.7.4
                          Runtime: LibreSSL 2.7.4
                                 : built on: date not available
Library version: PCRE: Compile: 8.42
                       Runtime: 8.42 2018-03-20
Loading lookup modules from /usr/lib/exim/
Loaded 0 lookup modules
Total 6 lookups
WHITELIST_D_MACROS unset
TRUSTED_CONFIG_LIST unset
changed uid/gid: forcing real = effective
  uid=0 gid=0 pid=109
  auxiliary group list: <none>
changed uid/gid: calling tls_validate_require_cipher
  uid=100 gid=101 pid=110
  auxiliary group list: <none>
tls_validate_require_cipher child 110 ended: status=0x0
configuration file is /etc/exim/exim.conf
log selectors = 0000cffc 63201022 00000000
trusted user
admin user
originator: uid=0 gid=0 login=root name=root
sender address = root@secondary.nevers.prac.os3.nl
Address testing: uid=0 gid=101 euid=0 egid=101
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Testing loop@nevers.prac.os3.nl
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Considering loop@nevers.prac.os3.nl
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
routing loop@nevers.prac.os3.nl
--------> dnslookup router <--------
local_part=loop domain=nevers.prac.os3.nl
checking domains
nevers.prac.os3.nl in "secondary.nevers.prac.os3.nl"? no (end of list)
nevers.prac.os3.nl in "! +local_domains"? yes (end of list)
calling dnslookup router
dnslookup router called for loop@nevers.prac.os3.nl
  domain = nevers.prac.os3.nl
DNS lookup of nevers.prac.os3.nl (MX) succeeded
DNS lookup of mailserver.nevers.prac.os3.nl (AAAA) succeeded
DNS lookup of mailserver.nevers.prac.os3.nl (A) succeeded
145.100.111.9 in "0.0.0.0 : 127.0.0.0/8"? no (end of list)
DNS lookup of secondary.nevers.prac.os3.nl (AAAA) succeeded
DNS lookup of secondary.nevers.prac.os3.nl (A) succeeded
145.100.111.10 in "0.0.0.0 : 127.0.0.0/8"? no (end of list)
DNS lookup of mulhouse.prac.os3.nl (AAAA) succeeded
DNS lookup of mulhouse.prac.os3.nl (A) succeeded
DNS lookup of mail.mulhouse.prac.os3.nl (AAAA) succeeded
2001:610:158:1043:145:100:104:115 in "0.0.0.0 : 127.0.0.0/8"? no (end of list)
DNS lookup of mail.mulhouse.prac.os3.nl (A) succeeded
145.100.104.115 in "0.0.0.0 : 127.0.0.0/8"? no (end of list)
DNS lookup of hull.prac.os3.nl (AAAA) succeeded
DNS lookup of hull.prac.os3.nl (A) succeeded
DNS lookup of mail.hull.prac.os3.nl (AAAA) succeeded
DNS lookup of mail.hull.prac.os3.nl (A) succeeded
145.100.104.167 in "0.0.0.0 : 127.0.0.0/8"? no (end of list)
fully qualified name = nevers.prac.os3.nl
host_find_bydns yield = HOST_FOUND (3); returned hosts:
  mailserver.nevers.prac.os3.nl 145.100.111.9 MX=10 
  secondary.nevers.prac.os3.nl 145.100.111.10 MX=11 
  mulhouse.prac.os3.nl <null> MX=20 *
  mail.mulhouse.prac.os3.nl 2001:610:158:1043:145:100:104:115 MX=21 
  mail.mulhouse.prac.os3.nl 145.100.104.115 MX=21 
  hull.prac.os3.nl <null> MX=30 *
  mail.hull.prac.os3.nl 145.100.104.167 MX=31 
set transport remote_smtp
queued for remote_smtp transport: local_part = loop
domain = nevers.prac.os3.nl
  errors_to=NULL
  domain_data=NULL localpart_data=NULL
routed by dnslookup router
  envelope to: loop@nevers.prac.os3.nl
  transport: remote_smtp
  host mailserver.nevers.prac.os3.nl [145.100.111.9] MX=10
  host secondary.nevers.prac.os3.nl [145.100.111.10] MX=11
  host mulhouse.prac.os3.nl MX=20
  host mail.mulhouse.prac.os3.nl [2001:610:158:1043:145:100:104:115] MX=21
  host mail.mulhouse.prac.os3.nl [145.100.104.115] MX=21
  host hull.prac.os3.nl MX=30
  host mail.hull.prac.os3.nl [145.100.104.167] MX=31
loop@nevers.prac.os3.nl
  router = dnslookup, transport = remote_smtp
  host mailserver.nevers.prac.os3.nl [145.100.111.9]                     MX=10
  host secondary.nevers.prac.os3.nl  [145.100.111.10]                    MX=11
  host mulhouse.prac.os3.nl          [unknown]                           MX=20 ** unusable **
  host mail.mulhouse.prac.os3.nl     [2001:610:158:1043:145:100:104:115] MX=21
  host mail.mulhouse.prac.os3.nl     [145.100.104.115]                   MX=21
  host hull.prac.os3.nl              [unknown]                           MX=30 ** unusable **
  host mail.hull.prac.os3.nl         [145.100.104.167]                   MX=31
search_tidyup called
>>>>>>>>>>>>>>>> Exim pid=109 (main) terminating with rc=0 >>>>>>>>>>>>>>>>
</code>

So another test, which worked:
<code>
2018-10-15 19:16:18 1gC8Li-00001n-SU <= sanderlentink@mdmail.nl H=(nevers.prac.os3.nl) [172.20.0.1] P=esmtps X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K S=3459 id=CAMU2pL8+Hb0889W6qpQKzyy0YQmpr5Zc6br3j+4oNC3yoxGTug@mail.gmail.com
2018-10-15 19:16:18 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-15 19:16:19 1gC8Li-00001n-SU [145.100.111.9] SSL verify error: depth=0 error=self signed certificate cert=/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl
2018-10-15 19:16:19 1gC8Li-00001n-SU [145.100.111.9] SSL verify error: certificate name mismatch: DN="/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl" H="mailserver.nevers.prac.os3.nl"
2018-10-15 19:16:19 1gC8Li-00001n-SU => loop@nevers.prac.os3.nl <loop@secondary.nevers.prac.os3.nl> R=dnslookup T=remote_smtp H=mailserver.nevers.prac.os3.nl [145.100.111.9] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 3528 byte chunk, total 3528\\n250 OK id=1gC8Lj-00001I-1c"
2018-10-15 19:16:19 1gC8Li-00001n-SU Completed
2018-10-15 19:16:19 1gC8Lj-00001r-6r <= sanderlentink@mdmail.nl H=(nevers.prac.os3.nl) [172.20.0.1] P=esmtps X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K S=4029 id=CAMU2pL8+Hb0889W6qpQKzyy0YQmpr5Zc6br3j+4oNC3yoxGTug@mail.gmail.com
2018-10-15 19:16:19 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-15 19:16:19 1gC8Lj-00001r-6r [145.100.111.9] SSL verify error: depth=0 error=self signed certificate cert=/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl
2018-10-15 19:16:19 1gC8Lj-00001r-6r [145.100.111.9] SSL verify error: certificate name mismatch: DN="/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl" H="mailserver.nevers.prac.os3.nl"
2018-10-15 19:16:19 1gC8Lj-00001r-6r => loop@nevers.prac.os3.nl <loop@secondary.nevers.prac.os3.nl> R=dnslookup T=remote_smtp H=mailserver.nevers.prac.os3.nl [145.100.111.9] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 4110 byte chunk, total 4110\\n250 OK id=1gC8Lj-00001M-Cn"
2018-10-15 19:16:19 1gC8Lj-00001r-6r Completed
2018-10-15 19:16:19 1gC8Lj-00001v-IR <= sanderlentink@mdmail.nl H=(nevers.prac.os3.nl) [172.20.0.1] P=esmtps X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K S=4599 id=CAMU2pL8+Hb0889W6qpQKzyy0YQmpr5Zc6br3j+4oNC3yoxGTug@mail.gmail.com
2018-10-15 19:16:19 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-15 19:16:19 1gC8Lj-00001v-IR [145.100.111.9] SSL verify error: depth=0 error=self signed certificate cert=/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl
2018-10-15 19:16:19 1gC8Lj-00001v-IR [145.100.111.9] SSL verify error: certificate name mismatch: DN="/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl" H="mailserver.nevers.prac.os3.nl"
2018-10-15 19:16:19 1gC8Lj-00001v-IR => loop@nevers.prac.os3.nl <loop@secondary.nevers.prac.os3.nl> R=dnslookup T=remote_smtp H=mailserver.nevers.prac.os3.nl [145.100.111.9] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 4692 byte chunk, total 4692\\n250 OK id=1gC8Lj-00001Q-OP"
2018-10-15 19:16:19 1gC8Lj-00001v-IR Completed
2018-10-15 19:16:20 1gC8Lj-00001z-U8 <= sanderlentink@mdmail.nl H=(nevers.prac.os3.nl) [172.20.0.1] P=esmtps X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K S=5169 id=CAMU2pL8+Hb0889W6qpQKzyy0YQmpr5Zc6br3j+4oNC3yoxGTug@mail.gmail.com
2018-10-15 19:16:20 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-15 19:16:20 1gC8Lj-00001z-U8 [145.100.111.9] SSL verify error: depth=0 error=self signed certificate cert=/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl
2018-10-15 19:16:20 1gC8Lj-00001z-U8 [145.100.111.9] SSL verify error: certificate name mismatch: DN="/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl" H="mailserver.nevers.prac.os3.nl"
2018-10-15 19:16:20 1gC8Lj-00001z-U8 => loop@nevers.prac.os3.nl <loop@secondary.nevers.prac.os3.nl> R=dnslookup T=remote_smtp H=mailserver.nevers.prac.os3.nl [145.100.111.9] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 5274 byte chunk, total 5274\\n250 OK id=1gC8Lk-00001U-3N"
2018-10-15 19:16:20 1gC8Lj-00001z-U8 Completed
2018-10-15 19:16:20 1gC8Lk-000023-7d <= sanderlentink@mdmail.nl H=(nevers.prac.os3.nl) [172.20.0.1] P=esmtps X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K S=5739 id=CAMU2pL8+Hb0889W6qpQKzyy0YQmpr5Zc6br3j+4oNC3yoxGTug@mail.gmail.com
2018-10-15 19:16:20 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-15 19:16:20 1gC8Lk-000023-7d [145.100.111.9] SSL verify error: depth=0 error=self signed certificate cert=/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl
2018-10-15 19:16:20 1gC8Lk-000023-7d [145.100.111.9] SSL verify error: certificate name mismatch: DN="/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl" H="mailserver.nevers.prac.os3.nl"
2018-10-15 19:16:20 1gC8Lk-000023-7d => loop@nevers.prac.os3.nl <loop@secondary.nevers.prac.os3.nl> R=dnslookup T=remote_smtp H=mailserver.nevers.prac.os3.nl [145.100.111.9] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 5856 byte chunk, total 5856\\n250 OK id=1gC8Lk-00001Y-Cy"
2018-10-15 19:16:20 1gC8Lk-000023-7d Completed
2018-10-15 19:16:20 1gC8Lk-000027-JD <= sanderlentink@mdmail.nl H=(nevers.prac.os3.nl) [172.20.0.1] P=esmtps X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K S=6309 id=CAMU2pL8+Hb0889W6qpQKzyy0YQmpr5Zc6br3j+4oNC3yoxGTug@mail.gmail.com
2018-10-15 19:16:20 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-15 19:16:20 1gC8Lk-000027-JD [145.100.111.9] SSL verify error: depth=0 error=self signed certificate cert=/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl
2018-10-15 19:16:20 1gC8Lk-000027-JD [145.100.111.9] SSL verify error: certificate name mismatch: DN="/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl" H="mailserver.nevers.prac.os3.nl"
2018-10-15 19:16:20 1gC8Lk-000027-JD => loop@nevers.prac.os3.nl <loop@secondary.nevers.prac.os3.nl> R=dnslookup T=remote_smtp H=mailserver.nevers.prac.os3.nl [145.100.111.9] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 6438 byte chunk, total 6438\\n250 OK id=1gC8Lk-00001c-Og"
2018-10-15 19:16:20 1gC8Lk-000027-JD Completed
2018-10-15 19:16:21 1gC8Lk-00002B-Uv <= sanderlentink@mdmail.nl H=(nevers.prac.os3.nl) [172.20.0.1] P=esmtps X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K S=6879 id=CAMU2pL8+Hb0889W6qpQKzyy0YQmpr5Zc6br3j+4oNC3yoxGTug@mail.gmail.com
2018-10-15 19:16:21 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-15 19:16:21 1gC8Lk-00002B-Uv [145.100.111.9] SSL verify error: depth=0 error=self signed certificate cert=/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl
2018-10-15 19:16:21 1gC8Lk-00002B-Uv [145.100.111.9] SSL verify error: certificate name mismatch: DN="/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl" H="mailserver.nevers.prac.os3.nl"
2018-10-15 19:16:21 1gC8Lk-00002B-Uv => loop@nevers.prac.os3.nl <loop@secondary.nevers.prac.os3.nl> R=dnslookup T=remote_smtp H=mailserver.nevers.prac.os3.nl [145.100.111.9] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 7020 byte chunk, total 7020\\n250 OK id=1gC8Ll-00001g-4c"
2018-10-15 19:16:21 1gC8Lk-00002B-Uv Completed
2018-10-15 19:16:21 1gC8Ll-00002F-9k <= sanderlentink@mdmail.nl H=(nevers.prac.os3.nl) [172.20.0.1] P=esmtps X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K S=7449 id=CAMU2pL8+Hb0889W6qpQKzyy0YQmpr5Zc6br3j+4oNC3yoxGTug@mail.gmail.com
2018-10-15 19:16:21 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-15 19:16:21 1gC8Ll-00002F-9k [145.100.111.9] SSL verify error: depth=0 error=self signed certificate cert=/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl
2018-10-15 19:16:21 1gC8Ll-00002F-9k [145.100.111.9] SSL verify error: certificate name mismatch: DN="/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl" H="mailserver.nevers.prac.os3.nl"
2018-10-15 19:16:21 1gC8Ll-00002F-9k => loop@nevers.prac.os3.nl <loop@secondary.nevers.prac.os3.nl> R=dnslookup T=remote_smtp H=mailserver.nevers.prac.os3.nl [145.100.111.9] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 7602 byte chunk, total 7602\\n250 OK id=1gC8Ll-00001k-FD"
2018-10-15 19:16:21 1gC8Ll-00002F-9k Completed
2018-10-15 19:16:21 1gC8Ll-00002J-LM <= sanderlentink@mdmail.nl H=(nevers.prac.os3.nl) [172.20.0.1] P=esmtps X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K S=8019 id=CAMU2pL8+Hb0889W6qpQKzyy0YQmpr5Zc6br3j+4oNC3yoxGTug@mail.gmail.com
2018-10-15 19:16:21 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-15 19:16:21 1gC8Ll-00002J-LM [145.100.111.9] SSL verify error: depth=0 error=self signed certificate cert=/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl
2018-10-15 19:16:21 1gC8Ll-00002J-LM [145.100.111.9] SSL verify error: certificate name mismatch: DN="/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl" H="mailserver.nevers.prac.os3.nl"
2018-10-15 19:16:21 1gC8Ll-00002J-LM => loop@nevers.prac.os3.nl <loop@secondary.nevers.prac.os3.nl> R=dnslookup T=remote_smtp H=mailserver.nevers.prac.os3.nl [145.100.111.9] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 8184 byte chunk, total 8184\\n250 OK id=1gC8Ll-00001o-RB"
2018-10-15 19:16:21 1gC8Ll-00002J-LM Completed
2018-10-15 19:16:22 1gC8Lm-00002N-0T <= sanderlentink@mdmail.nl H=(nevers.prac.os3.nl) [172.20.0.1] P=esmtps X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K S=8589 id=CAMU2pL8+Hb0889W6qpQKzyy0YQmpr5Zc6br3j+4oNC3yoxGTug@mail.gmail.com
2018-10-15 19:16:22 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-15 19:16:22 1gC8Lm-00002N-0T [145.100.111.9] SSL verify error: depth=0 error=self signed certificate cert=/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl
2018-10-15 19:16:22 1gC8Lm-00002N-0T [145.100.111.9] SSL verify error: certificate name mismatch: DN="/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl" H="mailserver.nevers.prac.os3.nl"
2018-10-15 19:16:22 1gC8Lm-00002N-0T => loop@nevers.prac.os3.nl <loop@secondary.nevers.prac.os3.nl> R=dnslookup T=remote_smtp H=mailserver.nevers.prac.os3.nl [145.100.111.9] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 836 byte chunk, total 8766\\n250 OK id=1gC8Lm-00001s-5o"
2018-10-15 19:16:22 1gC8Lm-00002N-0T Completed
2018-10-15 19:16:22 1gC8Lm-00002R-B7 <= sanderlentink@mdmail.nl H=(nevers.prac.os3.nl) [172.20.0.1] P=esmtps X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K S=9159 id=CAMU2pL8+Hb0889W6qpQKzyy0YQmpr5Zc6br3j+4oNC3yoxGTug@mail.gmail.com
2018-10-15 19:16:22 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-15 19:16:22 1gC8Lm-00002R-B7 [145.100.111.9] SSL verify error: depth=0 error=self signed certificate cert=/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl
2018-10-15 19:16:22 1gC8Lm-00002R-B7 [145.100.111.9] SSL verify error: certificate name mismatch: DN="/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl" H="mailserver.nevers.prac.os3.nl"
2018-10-15 19:16:22 1gC8Lm-00002R-B7 => loop@nevers.prac.os3.nl <loop@secondary.nevers.prac.os3.nl> R=dnslookup T=remote_smtp H=mailserver.nevers.prac.os3.nl [145.100.111.9] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 1157 byte chunk, total 9348\\n250 OK id=1gC8Lm-00001w-I1"
2018-10-15 19:16:22 1gC8Lm-00002R-B7 Completed
2018-10-15 19:16:22 1gC8Lm-00002V-Ne <= sanderlentink@mdmail.nl H=(nevers.prac.os3.nl) [172.20.0.1] P=esmtps X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K S=9729 id=CAMU2pL8+Hb0889W6qpQKzyy0YQmpr5Zc6br3j+4oNC3yoxGTug@mail.gmail.com
2018-10-15 19:16:22 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-15 19:16:22 1gC8Lm-00002V-Ne [145.100.111.9] SSL verify error: depth=0 error=self signed certificate cert=/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl
2018-10-15 19:16:22 1gC8Lm-00002V-Ne [145.100.111.9] SSL verify error: certificate name mismatch: DN="/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl" H="mailserver.nevers.prac.os3.nl"
2018-10-15 19:16:23 1gC8Lm-00002V-Ne => loop@nevers.prac.os3.nl <loop@secondary.nevers.prac.os3.nl> R=dnslookup T=remote_smtp H=mailserver.nevers.prac.os3.nl [145.100.111.9] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 1739 byte chunk, total 9930\\n250 OK id=1gC8Lm-000020-T3"
2018-10-15 19:16:23 1gC8Lm-00002V-Ne Completed
2018-10-15 19:16:23 1gC8Ln-00002Z-3b <= sanderlentink@mdmail.nl H=(nevers.prac.os3.nl) [172.20.0.1] P=esmtps X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K S=10299 id=CAMU2pL8+Hb0889W6qpQKzyy0YQmpr5Zc6br3j+4oNC3yoxGTug@mail.gmail.com
2018-10-15 19:16:23 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-15 19:16:23 1gC8Ln-00002Z-3b [145.100.111.9] SSL verify error: depth=0 error=self signed certificate cert=/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl
2018-10-15 19:16:23 1gC8Ln-00002Z-3b [145.100.111.9] SSL verify error: certificate name mismatch: DN="/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl" H="mailserver.nevers.prac.os3.nl"
2018-10-15 19:16:23 1gC8Ln-00002Z-3b => loop@nevers.prac.os3.nl <loop@secondary.nevers.prac.os3.nl> R=dnslookup T=remote_smtp H=mailserver.nevers.prac.os3.nl [145.100.111.9] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 2321 byte chunk, total 10512\\n250 OK id=1gC8Ln-000024-9i"
2018-10-15 19:16:23 1gC8Ln-00002Z-3b Completed
2018-10-15 19:16:23 1gC8Ln-00002d-F3 <= sanderlentink@mdmail.nl H=(nevers.prac.os3.nl) [172.20.0.1] P=esmtps X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K S=10869 id=CAMU2pL8+Hb0889W6qpQKzyy0YQmpr5Zc6br3j+4oNC3yoxGTug@mail.gmail.com
2018-10-15 19:16:23 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-15 19:16:23 1gC8Ln-00002d-F3 [145.100.111.9] SSL verify error: depth=0 error=self signed certificate cert=/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl
2018-10-15 19:16:23 1gC8Ln-00002d-F3 [145.100.111.9] SSL verify error: certificate name mismatch: DN="/C=UK/O=Exim Developers/CN=nevers.prac.os3.nl" H="mailserver.nevers.prac.os3.nl"
2018-10-15 19:16:23 1gC8Ln-00002d-F3 => loop@nevers.prac.os3.nl <loop@secondary.nevers.prac.os3.nl> R=dnslookup T=remote_smtp H=mailserver.nevers.prac.os3.nl [145.100.111.9] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 2903 byte chunk, total 11094\\n250 OK id=1gC8Ln-000028-Jx"
2018-10-15 19:16:23 1gC8Ln-00002d-F3 Completed
2018-10-15 19:16:23 1gC8Ln-00002h-PE <= sanderlentink@mdmail.nl H=(nevers.prac.os3.nl) [172.20.0.1] P=esmtps X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K S=11439 id=CAMU2pL8+Hb0889W6qpQKzyy0YQmpr5Zc6br3j+4oNC3yoxGTug@mail.gmail.com
2018-10-15 19:16:23 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-15 19:16:23 1gC8Ln-00002h-PE ** loop@secondary.nevers.prac.os3.nl: Too many "Received" headers - suspected mail loop
2018-10-15 19:16:23 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-15 19:16:23 1gC8Ln-00002k-SY <= <> R=1gC8Ln-00002h-PE U=exim P=local S=12678
2018-10-15 19:16:23 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-15 19:16:24 1gC8Ln-00002k-SY H=aspmx.l.google.com [2a00:1450:4013:c06::1a] Address not available
2018-10-15 19:16:24 1gC8Ln-00002h-PE Completed
2018-10-15 19:16:24 1gC8Ln-00002k-SY => sanderlentink@mdmail.nl R=dnslookup T=remote_smtp H=aspmx.l.google.com [108.177.127.26] X=TLSv1.2:ECDHE-RSA-CHACHA20-POLY1305:256 CV=yes K C="250 2.0.0 OK t6-v6si1836231edt.159 - gsmtp"
2018-10-15 19:16:24 1gC8Ln-00002k-SY Completed
</code>

What happens:
<code>
2018-10-15 19:16:23 1gC8Ln-000028-Jx => loop@secondary.nevers.prac.os3.nl <loop@nevers.prac.os3.nl> R=dnslookup T=remote_smtp H=secondary.nevers.prac.os3.nl [145.100.111.10] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 3189 byte chunk, total 11380\\n250 OK id=1gC8Ln-00002h-PE"
</code>

<code>
2018-10-15 19:29:09 1gC8Y9-000035-65 => loop@secondary.nevers.prac.os3.nl <loop@nevers.prac.os3.nl> R=dnslookup T=remote_smtp H=secondary.nevers.prac.os3.nl [145.100.111.10] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 2929 byte chunk, total 11120\\n250 OK id=1gC8Y9-00003q-BM"
</code>

The max header length or hop count is reached.

=== Q2. Can you change the behaviour of your MTA in response to this loop?  ===

The [[https://www.exim.org/exim-html-current/doc/html/spec_html/ch-main_configuration.html|documenations]] tells us:
<code>
header_maxsize	total size of message header
header_line_maxsize	individual header line limit
</code>

We read [[http://www.exim.org/exim-html-3.20/doc/html/spec_5.html|here]]
that the hop count has no effect:
<code>
-h <number>
This option is accepted for compatibility with Sendmail, but at present has no effect. (In Sendmail it overrides the `hop count' obtained by counting Received: headers.)
</code>

=== Q3.  ===
== a. Create a new subdomain within your domain and add an MX entry to it  ==

<code>
root@nevers:/home/slentink# dig nevers.prac.os3.nl mx +short
30 hull.prac.os3.nl.
10 mailserver.nevers.prac.os3.nl.
21 mail.mulhouse.prac.os3.nl.
31 mail.hull.prac.os3.nl.
20 mulhouse.prac.os3.nl.
11 secondary.nevers.prac.os3.nl.
root@nevers:/home/slentink# dig secondary.nevers.prac.os3.nl mx +short                                 
0 secondary.nevers.prac.os3.nl.
</code>

Since I already had a subdomain,
I just bind one docker-container to both IPs

== b. Then extend your MTA configuration to handle virtual domains and have it also handle the email for the newly created domain  == 

and set local domains to:
<code>
domainlist local_domains = nevers.prac.os3.nl : secondary.nevers.prac.os3.nl
</code>

== c. Show how you test this  ==

<code>
version: '3'
services:
  exim:
    image: exim
    ports:
      - '145.100.111.9:25:25'
      - '145.100.111.10:25:25'
    volumes:
      - $PWD/exim3.conf:/etc/exim/exim.conf:ro
      - $PWD/aliases2:/etc/mail/aliases:ro
      - $PWD/mailname2:/etc/mail/mailname:ro
    entrypoint: ["sh","-c"]
    command: ["mkdir -p /var/mail; chmod 777 /var/mail; adduser -D os3student; /usr/sbin/exim -bdf -q15m"]

</code>
It now for both postmaster@(secondary.)nevers.prac.os3.nl
and stores it in /var/mai/os3student.


Which I already discovered in the previous lab,
when I used secondary as my backup and had both domains in local_domains.
When the primary was down, the secondary would receive and store it.


=== Q4.  ===
== a. Write a small paragraph that highlights the advantages and disadvantages of SPF and DomainKeys Identified Mail (DKIM)  == 

First we note that receivers are different,
some check only one of the two,
therefore the advice is to have both.

DKIM signs the email,
which prevents alteration of the mail,
SPF does not offer this.

SPF defines which sources (IPs) the email could come from (senders),
DKIM tells us by which key it is signed.
Both records are stored in DNS.

[[https://blog.woodpecker.co/cold-email/spf-dkim/|src]]

== b. What would you choose at a first glance and why?  ==

I like to be portable, if I want to send from my laptop,
without a server, SPF would require me to at my IP of that place.
With DKIM, I can just sign and send from any place
and the contents cannot be altered.

DKIM is my weapon of choice,
but wait,
servers usually are more into checking sources based on SPF,
oh well, I just go with the flow and use both.
I'm not an idealist but a realist,
I want my email to be delivered.

[[https://3.bp.blogspot.com/-uUck832XVq4/VrqPLXM5-BI/AAAAAAAAAQg/mo9OPpUCOTQ/s1600/email-authentication-stats-gmail-2016.png|src]]

== c. Configure your system to support one of the two Your system must support it for both sending and receiving email You might need additional software packages or patches  == 

For SPF, no additional alterations are needed on the MTA,
only if we want it to check incoming, not for sending.
So the choice is, do we want to change DNS (SPF) or DNS and MTA (DKIM).
It will be SPF.
<code>
v=spf1 mx ~all
</code>
The tilde means SoftFail.
[[http://www.openspf.org/SPF_Record_Syntax|src]]

Which was inserted:
<code>
dig nevers.prac.os3.nl txt +short
"v=spf1" "mx" "~all"
root@lent:~/Dropbox/webIDE/bind# dig secondary.nevers.prac.os3.nl txt +short           
"v=spf1" "mx" "~all"
</code>

So if we now have outgoing mail from my MTA,
the sender could check that the SPF records match.
For incoming email (e.g. from gmail),
nothing has changed.

To check incoming we find how to config exim
[[https://www.exim.org/exim-html-current/doc/html/spec_html/ch-dkim_and_spf.html|here]].
We copied their example:
<code>
acl_check_rcpt:

  deny spf = fail
     message = $sender_host_address is not allowed to send mail from \
               ${if def:sender_address_domain \
                    {$sender_address_domain}{$sender_helo_name}}.  \
               Please see http://www.openspf.org/Why?scope=\
               ${if def:sender_address_domain {mfrom}{helo}};\
               identity=${if def:sender_address_domain \
                             {$sender_address}{$sender_helo_name}};\
               ip=$sender_host_address
</code>
[[https://github.com/os3nl/exim/commit/f400e4f668a7d7f039e3cda4776d6b0177e62926|link to commit]].

And with no surprise, gmail still comes through,
SPF records are correct.

== d. Provide full email/MTA headers to prove that SPF/DKIM were implemented correctly on your system (sending and receiving)  == 

We send an email:
<code>
root@nevers:~/exim# docker exec -it exim_backup_1 sh
/ # sendmail sanderlentink@mdmail.nl <<'EOF'
From: "student" <postmaster@secondary.nevers.prac.os3.nl>
To: "werknemer" <sanderlentink@mdmail.nl>
Reply-To: postmaster@secondary.nevers.prac.os3.nl
Subject: spf
Content-Type: text/plain; charset=utf-8

test
EOF
</code>

Which did come in spam folder, but SPF passed:
<code>
Delivered-To: sanderlentink@mdmail.nl
Received: by 2002:ac2:5094:0:0:0:0:0 with SMTP id f20-v6csp4910595lfm;
        Mon, 15 Oct 2018 23:55:03 -0700 (PDT)
X-Google-Smtp-Source: ACcGV63MnbZoqSOUyhDMMsRCZBi8F/Dzps01CbjMBpxug7Y+sOoH8tTiXGQez6zXuNemaZiUMWsq
X-Received: by 2002:a17:906:7845:: with SMTP id p5-v6mr22405848ejm.213.1539672903362;
        Mon, 15 Oct 2018 23:55:03 -0700 (PDT)
ARC-Seal: i=1; a=rsa-sha256; t=1539672903; cv=none;
        d=google.com; s=arc-20160816;
        b=F57FdBSkrm98yLipOdYxLKvBcV9b5qi3VPt/PyeB8j9UoQExglZjH0UgmMQZcGpBnZ
         sRFXUqwqpBB4lq3Xm8luOmllSQSFLNcOsiy6mGZUe8T6KPSmzWf5O/7tLoyY052m8nCo
         1J47wH0YW5xKTPPrEDdbD8Uj+GynLE6NlnSV8xgjA6WUBkIk5HzAqt74qYDW/DG/w0Ze
         4SWAzHnwMRJek/FIezP0BIZ/AydzluVMk5o/tKwqBqqhn1x/tbMONH5mc68MY6esBU6h
         GVxwu3yf7Eu/8obkYI8/BxVezX3GvCTKJH+JPxc5VyDlhWBoDPq1KeG/Cmob7bvFj4Sw
         +uDA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;
        h=date:message-id:subject:reply-to:to:from;
        bh=g3zLYH4xKxcPrHOD18z9YfpQcnk/GaJedfustWU5uGs=;
        b=tFtkUg7ZMtEgycJeQFsukvCytjiv2KQYqqTi1EWhNLlzw3zipp35BY8Cm8JsIxdl0z
         mokmOWac33TMLZC1/8jf7I+92ZVdgoP2JfFvivrxdo4MVFHkXh7RrIT40Ks/iGqoDuMy
         yZ+8CSj12c2BJZq598s3IvsmYn9xOBIIGIji70tn1jkNCy4eD5M7dGbC4KnOsNQBXRG0
         FidWe97Hpdse7tAbJlOJkv4fYR4mQcZoPw200zzT/BZolj8PBv1cbRcleMmSc2GrzUH7
         Ed+3JfPNJvC8Q0lFj7JU2HC4BY8ADD9dXB90NuPw7nokkhVh0ZCt8Qj2lEljrpt1HG6G
         zajA==
ARC-Authentication-Results: i=1; mx.google.com;
       spf=pass (google.com: best guess record for domain of root@secondary.nevers.prac.os3.nl designates 145.100.104.117 as permitted sender) smtp.mailfrom=root@secondary.nevers.prac.os3.nl
Return-Path: <root@secondary.nevers.prac.os3.nl>
Received: from secondary.nevers.prac.os3.nl (nevers.studlab.os3.nl. [145.100.104.117])
        by mx.google.com with ESMTPS id z28-v6si7848865edl.239.2018.10.15.23.55.02
        for <sanderlentink@mdmail.nl>
        (version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
        Mon, 15 Oct 2018 23:55:02 -0700 (PDT)
Received-SPF: pass (google.com: best guess record for domain of root@secondary.nevers.prac.os3.nl designates 145.100.104.117 as permitted sender) client-ip=145.100.104.117;
Authentication-Results: mx.google.com;
       spf=pass (google.com: best guess record for domain of root@secondary.nevers.prac.os3.nl designates 145.100.104.117 as permitted sender) smtp.mailfrom=root@secondary.nevers.prac.os3.nl
Received: from root by secondary.nevers.prac.os3.nl with local (Exim 4.91) (envelope-from <root@secondary.nevers.prac.os3.nl>) id 1gCJFt-00005o-UT for sanderlentink@mdmail.nl; Tue, 16 Oct 2018 06:55:01 +0000
From: student <postmaster@secondary.nevers.prac.os3.nl>
To: werknemer <sanderlentink@mdmail.nl>
Reply-To: postmaster@secondary.nevers.prac.os3.nl
Subject: spf
Content-Type: text/plain; charset=utf-8
Message-Id: <E1gCJFt-00005o-UT@secondary.nevers.prac.os3.nl>
Date: Tue, 16 Oct 2018 06:55:01 +0000

test
</code>

See the line (from above msg):
<code>
Received-SPF: pass (google.com: best guess
</code>

We have seen that for outgoing mail,
we set our SPF in our DNS.
For incoming mail, we specify an ACL,
to check incoming mail.


=== Q5. Investigate what generic anti-spam open source software packages are out there choose one download it (compile it if necessary) and configure your MTA to use it Show that it works Make sure that in your MTA group there are 2 different anti-spam solutions implemented  ===

We read
[[https://www.exim.org/exim-html-current/doc/html/spec_html/ch-content_scanning_at_acl_time.html|here]]
the options for Exim.

During our initial build, we had WITH_CONTENT_SCAN set to yes.

We search for packages in Alpine:
<code>
/ # apk search -v '*mail*' |grep -i scan
claws-mail-plugins-clamd-3.15.1-r0 - Use Clam AntiVirus to scan messages in Claws Mail
perl-mail-clamav-0.29-r14 - Perl extension for the clamav virus scanner
perl-mail-clamav-doc-0.29-r14 - Perl extension for the clamav virus scanner (documentation)
/ # apk search -v '*mail*' |grep -i spam
claws-mail-plugins-spamassassin-3.15.1-r0 - Spamassassin plugin for Claws Mail
perl-mail-spamassassin-doc-3.4.1-r2 - SpamAssassin is an extensible email filter which is used to identify spam (documentation)
claws-mail-plugins-spamreport-3.15.1-r0 - Report spam mail to various places with Claws Mail
perl-mail-spamassassin-3.4.1-r8 - SpamAssassin perl library
/ # apk search -v '*mail*' |grep -i attach
claws-mail-plugins-att-remove-3.15.1-r0 - Attachments remover plugin for Claws Mail
claws-mail-plugins-attatchwarner-3.15.1-r0 - Attachments warner plugin for Claws Mail

</code>

When going manually through all mail options (without grep)
we find more interesting stuff (that I put here, for me to lookup later):
<code>
roundcubemail-installer-1.3.6-r1 - Roundcubemail installer script
kamailio-rabbitmq-5.1.4-r0 - Kamailio RabbitMQ related modules for Kamailio
kamailio-5.1.4-r0 - Open Source SIP Server
kamailio-cpl-5.1.4-r0 - Kamailio CPL (Call Processing Language) interpreter
kamailio-redis-5.1.4-r0 - Kamailio Redis NoSQL support
kamailio-xmpp-5.1.4-r0 - Kamailio XMPP (Jabber) gateway
kamailio-kazoo-5.1.4-r0 - Kamailio Kazoo VoIP platform support
gnupg-2.2.8-r0 - GNU Privacy Guard 2 - a PGP replacement tool
mmh-0.3-r1 - MUA for users who like the unix philosophy
kamailio-dbg-5.1.4-r0 - Open Source SIP Server (debug symbols)
kamailio-ldap-5.1.4-r0 - Kamailio LDAP search functions
kamailio-carrierroute-5.1.4-r0 - Kamailio carrier grade routing functions
</code>

So we install a scanner:
<code>
/ # apk add --no-cache clamav
fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/main/x86_64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/community/x86_64/APKINDEX.tar.gz
(1/10) Installing fts (1.2.7-r1)
(2/10) Installing ncurses-terminfo-base (6.1_p20180818-r1)
(3/10) Installing ncurses-terminfo (6.1_p20180818-r1)
(4/10) Installing ncurses-libs (6.1_p20180818-r1)
(5/10) Installing clamav-daemon (0.100.1-r0)
Executing clamav-daemon-0.100.1-r0.pre-install
(6/10) Installing libbz2 (1.0.6-r6)
(7/10) Installing clamav-libs (0.100.1-r0)
(8/10) Installing freshclam (0.100.1-r0)
Executing freshclam-0.100.1-r0.pre-install
(9/10) Installing clamav-scanner (0.100.1-r0)
(10/10) Installing clamav (0.100.1-r0)
Executing busybox-1.28.4-r1.trigger
OK: 19 MiB in 27 packages
</code>

exim config:
<code>
av_scanner = clamd:/run/clamav/clamd.sock
</code>

Debugging:
<code>
/ # clamd
LibClamAV Error: cli_loaddbdir(): No supported database files found in /var/lib/clamav
Wed Oct 17 09:52:04 2018 -> !Can't open file or directory
/ # apk search -v '*clam*'
freshclam-0.100.1-r0 - Auto-updater for the Clam Antivirus scanner data-files
clamav-dev-0.100.1-r0 - An anti-virus toolkit for UNIX eis-ng backport (development files)
clamav-libs-0.100.1-r0 - An anti-virus toolkit for UNIX eis-ng backport (libraries)
acf-clamav-0.8.0-r2 - A web-based system administration interface for clamav
clamav-daemon-0.100.1-r0 - ClamAV daemon scanner
nagios-plugins-tcp-2.2.1-r5 - Nagios plugins check_tcp, check_clamd, check_ftp, check_imap, check_jabber, check_nntp, check_nntps, check_pop, check_simap, check_spop, check_ssmtp, check_udp
clamav-db-0.100.1-r0 - ClamAV dummy package for compatibility
clamsmtp-1.10-r15 - An SMTP Virus Filter
clamav-libunrar-0.100.1-r0 - ClamAV unrar libraries
clamav-daemon-openrc-0.100.1-r0 - ClamAV anti-virus scanner daemon (OpenRC init scripts)
claws-mail-plugins-clamd-3.15.1-r0 - Use Clam AntiVirus to scan messages in Claws Mail
perl-mail-clamav-0.29-r14 - Perl extension for the clamav virus scanner
freshclam-openrc-0.100.1-r0 - Auto-updater for the Clam Antivirus scanner data-files (OpenRC init scripts)
clamav-scanner-0.100.1-r0 - ClamAV command-line scanner and utils
clamav-milter-0.100.1-r0 - ClamAV milter
perl-mail-clamav-doc-0.29-r14 - Perl extension for the clamav virus scanner (documentation)
clamav-doc-0.100.1-r0 - An anti-virus toolkit for UNIX eis-ng backport (documentation)
clamsmtp-doc-1.10-r15 - An SMTP Virus Filter (documentation)
acf-clamsmtp-0.6.0-r2 - A web-based system administration interface for clamsmtp
clamav-0.100.1-r0 - An anti-virus toolkit for UNIX eis-ng backport
/ # apk add --no-cache clamav-libs
fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/main/x86_64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/community/x86_64/APKINDEX.tar.gz
OK: 19 MiB in 27 packages
/ # apk add --no-cache clamav-db
fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/main/x86_64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/community/x86_64/APKINDEX.tar.gz
(1/1) Installing clamav-db (0.100.1-r0)
Executing busybox-1.28.4-r1.trigger
OK: 19 MiB in 28 packages
/ # apk add --no-cache clamav-scanner
fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/main/x86_64/APKINDEX.tar.gz
fetch http://dl-cdn.alpinelinux.org/alpine/v3.8/community/x86_64/APKINDEX.tar.gz
OK: 19 MiB in 28 packages
</code>

We could use this default,
but lets make it a bit more creative:
<code>
av_scanner = cmdline:/bin/cat %s:viagra:'(.+)'

#and under data acl section
deny message = This message contains malware ($malware_name)
     malware = *
</code>
It cats the content and tries to match viagra.
but.. it did not come through,
somewhere, an intermediate also filters (or google does not send out 'buy viagra').

So we changed it to match on 'windows'.
<code>
2018-10-17 10:04:57 1gCihF-00000E-2w malware acl condition: cmdline  : scanner returned error code: 256
2018-10-17 10:04:57 1gCihF-00000E-2w H=(mail-lf1-f42.google.com) [209.85.167.42] X=TLSv1.2:ECDHE-RSA-AES128-GCM-SHA256:128 CV=no F=<sanderlentink@mdmail.nl> temporarily rejected after DATA
</code>
Our scanning works!


=== Q6. Investigate these methods and add authentication to your MTA Show that it works  ===

