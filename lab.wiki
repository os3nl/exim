====== MTA1 Template ======

=== Q1. As per usual explain everything you have done in your log and how  ===

The code can be found [[https://github.com/os3nl/exim|here]]

== a. First make sure that your system does not contain a pre-installed version of the MTA of your choice if so remove it before you continue  == 
<code>
RUN (which exim && echo exim found && exit 1) || true
</code>
== b. Make sure the source code is retrieved from a secure location Use the official website for the MTA of your choice  == 
<code>
ARG EXIM_VERSION=4.91
ARG EXIM_URL=ftp://mirror.easyname.at/exim-ftp/exim/exim4/exim-$EXIM_VERSION.tar.gz
RUN wget -O /tmp/exim.tgz $EXIM_URL
# which is from the first source found at https://www.exim.org/mirmon/ftp_mirrors.html
</code>
== c. Because it is important that an MTA be correct and secure it is often signed using a digital PGP signature If your MTA is signed then make sure Within reason please do not email the authors you have downloaded the correct sources by checking the validity of the key and the signature  == 
<code>
RUN wget -O /tmp/exim.asc $EXIM_URL.asc
# which is signed by 'the file nigel-pubkey.asc'
# src: https://www.exim.org/exim-html-current/doc/html/spec_html/ch-introduction.html
ARG KEYFILEURL=ftp://mirror.easyname.at/exim-ftp/exim/nigel-pubkey.asc
RUN wget -O /tmp/key $KEYFILEURL
RUN gpg --import /tmp/key
# But this failed:
# gpg: Signature made Sun Apr 15 13:23:10 2018 UTC
# gpg:                using RSA key BCE58C8CE41F32DF
# gpg: Can't check signature: No public key
# So we read further at the source above:
# At time of last update, releases were being made by Jeremy Harris
# and signed with key 0xBCE58C8CE41F32DF.
# Other recent keys used for signing are those of Heiko Schlittermann,
# 0x26101B62F69376CE, and of Phil Pennock, 0x4D1E900E14C1CC04.
ARG KEYSURL=ftp://mirror.easyname.at/exim-ftp/exim/Exim-Maintainers-Keyring.asc
ARG KEYSURL=http://exim.mirror.colo-serv.net/exim/Exim-Maintainers-Keyring.asc
RUN wget -O /tmp/keys $KEYSURL
RUN gpg --import /tmp/keys
RUN gpg --verify /tmp/exim.asc /tmp/exim.tgz
</code>

which outputs:
<code>
Step 15/15 : RUN gpg --verify /tmp/exim.asc /tmp/exim.tgz
 ---> Running in ebd8d8829baa
gpg: Signature made Sun Apr 15 13:23:10 2018 UTC
gpg:                using RSA key BCE58C8CE41F32DF
gpg: Good signature from "Jeremy Harris (none) <jgh@wizmail.org>" [unknown]
gpg:                 aka "Jeremy Harris <jgh@redhat.com>" [unknown]
gpg: WARNING: This key is not certified with a trusted signature!
gpg:          There is no indication that the signature belongs to the owner.
Primary key fingerprint: A986 F3A6 BD63 77D8 7309  58DE BCE5 8C8C E41F 32DF
</code>
== d. There are a number of options that you will have to enter before compilation so that the functionality can be compiled into the program Make sure the basic install holds all the necessary functionality Show the options you configured  == 
<code>
ARG ALPINEMAKE=https://git.alpinelinux.org/cgit/aports/plain/community/exim/exim.Makefile
RUN wget -O /tmp/exim/Local/Makefile $ALPINEMAKE
RUN sed -i -e 's/-lnsl//g' -e 's/^HAVE_ICONV.*$//' \
  /tmp/exim/OS/Makefile-Linux
</code>

The options used:
<code>
curl --silent \
  https://git.alpinelinux.org/cgit/aports/plain/community/exim/exim.Makefile \
  | sed -e 's/-lnsl//g' -e 's/^HAVE_ICONV.*$//'           
AUTH_CRAM_MD5=yes
AUTH_DOVECOT=yes
AUTH_PLAINTEXT=yes
AUTH_SPA=yes
AUTH_TLS=yes
BIN_DIRECTORY=/usr/sbin
CFLAGS_DYNAMIC=-shared -rdynamic -fPIC
COMPRESS_COMMAND=/bin/gzip
COMPRESS_SUFFIX=gz
CONFIGURE_FILE=/etc/exim/exim.conf
CONFIGURE_FILE_USE_EUID=yes
CONFIGURE_FILE_USE_NODE=yes
EXICYCLOG_MAX=10
EXIM_USER=ref:exim
EXPAND_DLFUNC=yes
EXPERIMENTAL_CERTNAMES=yes
EXPERIMENTAL_EVENT=yes
EXPERIMENTAL_INTERNATIONAL=yes
EXPERIMENTAL_SOCKS=yes
EXPERIMENTAL_SPF=yes
EXTRALIBS_EXIM=-export-dynamic -rdynamic -ldl
FIXED_NEVER_USERS=root
HAVE_IPV6=YES
HEADERS_CHARSET="ISO-8859-1"
LDFLAGS += -lidn
LDFLAGS += -lspf2
LOG_FILE_PATH=/var/log/exim/%slog
LOOKUP_CDB=2
LOOKUP_DBM=2
LOOKUP_DNSDB=2
LOOKUP_DSEARCH=yes
LOOKUP_LSEARCH=yes
LOOKUP_MODULE_DIR=/usr/lib/exim/
LOOKUP_MYSQL=2
LOOKUP_MYSQL_INCLUDE=-I/usr/include/mysql
LOOKUP_MYSQL_LIBS=-Wl,--no-as-needed -lmysqlclient
LOOKUP_PASSWD=yes
LOOKUP_PGSQL=2
LOOKUP_PGSQL_INCLUDE=-I/usr/include/postgresql
LOOKUP_PGSQL_LIBS=-Wl,--no-as-needed -lpq
LOOKUP_SQLITE=2
LOOKUP_SQLITE_LIBS=-Wl,--no-as-needed -lsqlite3
MAKE_SHELL=/bin/bash
NO_SYMLINK=yes
PCRE_CONFIG=yes
PCRE_LIBS=-lpcre
PID_FILE_PATH=/run/exim.pid
ROUTER_ACCEPT=yes
ROUTER_DNSLOOKUP=yes
ROUTER_IPLITERAL=yes
ROUTER_IPLOOKUP=yes
ROUTER_MANUALROUTE=yes
ROUTER_QUERYPROGRAM=yes
ROUTER_REDIRECT=yes
SPOOL_DIRECTORY=/var/spool/exim
SUPPORT_CRYPTEQ=yes
SUPPORT_MAILDIR=yes
SUPPORT_MOVE_FROZEN_MESSAGES=yes
SUPPORT_PROXY=yes
SUPPORT_TLS=yes
SYSLOG_LOG_PID=no
SYSTEM_ALIASES_FILE=/etc/mail/aliases
TMPDIR="/tmp"
TRANSPORT_APPENDFILE=yes
TRANSPORT_AUTOREPLY=yes
TRANSPORT_LMTP=yes
TRANSPORT_PIPE=yes
TRANSPORT_SMTP=yes
USE_OPENSSL_PC=openssl
WITH_CONTENT_SCAN=yes
WITH_OLD_DEMIME=yes
ZCAT_COMMAND=
</code>

Installing
<code>
RUN make Makefile
RUN make -j1
RUN make INSTALL_ARG="exim_dbmbuild exim_dumpdb exim_tidydb exim_fixdb exim_lock" install
RUN adduser -D exim
RUN make INSTALL_ARG="exim" install
# Since we have two, we symlink (/usr/sbin/exim-4.91-6  /usr/sbin/exim-4.91-8)
RUN ln -s `ls /usr/sbin/exim-*|tail -1` /usr/sbin/exim
ENTRYPOINT ["/usr/sbin/exim"]
</code>

The adduser was needed since we got:
<code>
*** Could not run ./exim -bV -C /dev/null to find version number ***
*** Exim installation failed ***
exim: failed to find uid for user name "exim"
make: *** [Makefile:85: install] Error 1
</code>

After the installation we
[[https://www.exim.org/exim-html-current/doc/html/spec_html/ch-building_and_installing_exim.html|test]] (ch.19):
<code>
docker run -it --rm exim -bV
Exim version 4.91 #6 built 05-Oct-2018 13:04:27
Copyright (c) University of Cambridge, 1995 - 2018
(c) The Exim Maintainers and contributors in ACKNOWLEDGMENTS file, 2007 - 2018
Berkeley DB: Berkeley DB 5.3.28: (September  9, 2013)
Support for: crypteq IPv6 Expand_dlfunc OpenSSL move_frozen_messages Content_Scanning DKIM DNSSEC Event OCSP PRDR PROXY TCP_Fast_Open
Lookups (built-in): lsearch wildlsearch nwildlsearch iplsearch dsearch passwd
Authenticators: cram_md5 dovecot plaintext spa tls
Routers: accept dnslookup ipliteral iplookup manualroute queryprogram redirect
Transports: appendfile/maildir autoreply lmtp pipe smtp
Malware: f-protd f-prot6d drweb aveserver fsecure kavdaemon sophie clamd mksd avast sock cmdline
Fixed never_users: 0
Configure owner: 0:0
Size of off_t: 8
2018-10-05 13:17:32 Couldn't open /usr/lib/exim/: not loading lookup modules

2018-10-05 13:17:32 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-05 13:17:32 Warning: purging the environment.
 Suggested action: use keep_environment.
Configuration file is /etc/exim/exim.conf
</code>

=== Q2. Most of the options for an MTA can be found in a configuration file that will be loaded when the MTA starts It is recommended to start with an example configuration that looks a lot like what you need for now Show how you adapt it to your needs  ===

I retrieved the default config by doing
<code>
docker run -it --rm exim cat /etc/exim/exim.conf > exim.conf
</code>

But this was very large,
online they suggested:
<code>
apt update
apt install -y exim4-config 
dpkg-reconfigure exim4-config
</code>

Generating the config:
<code>
root@8b810ce9eb73:/# dpkg-reconfigure exim4-config
debconf: unable to initialize frontend: Dialog
debconf: (No usable dialog-like program is installed, so the dialog based frontend cannot be used. at /usr/share/perl5/Debconf/FrontEnd/Dialog.pm line 76.)
debconf: falling back to frontend: Readline
debconf: unable to initialize frontend: Readline
debconf: (Can't locate Term/ReadLine.pm in @INC (you may need to install the Term::ReadLine module) (@INC contains: /etc/perl /usr/local/lib/x86_64-linux-gnu/perl/5.24.1 /usr/local/share/perl/5.24.1 /usr/lib/x86_64-linux-gnu/perl5/5.24 /usr/share/perl5 /usr/lib/x86_64-linux-gnu/perl/5.24 /usr/share/perl/5.24 /usr/local/lib/site_perl /usr/lib/x86_64-linux-gnu/perl-base .) at /usr/share/perl5/Debconf/FrontEnd/Readline.pm line 7.)
debconf: falling back to frontend: Teletype
Mail Server configuration
-------------------------

Please select the mail server configuration type that best meets your needs.

Systems with dynamic IP addresses, including dialup systems, should generally be configured to
send outgoing mail to another machine, called a 'smarthost' for delivery because many receiving
systems on the Internet block incoming mail from dynamic IP addresses as spam protection.

A system with a dynamic IP address can receive its own mail, or local delivery can be disabled
entirely (except mail for root and postmaster).

  1. internet site; mail is sent and received directly using SMTP
  2. mail sent by smarthost; received via SMTP or fetchmail
  3. mail sent by smarthost; no local mail
  4. local delivery only; not on a network
  5. no configuration at this time
General type of mail configuration: 1

The 'mail name' is the domain name used to 'qualify' mail addresses without a domain name.

This name will also be used by other programs. It should be the single, fully qualified domain
name (FQDN).

Thus, if a mail address on the local host is foo@example.org, the correct value for this option
would be example.org.

This name won't appear on From: lines of outgoing messages if rewriting is enabled.

System mail name: nevers.studlab.os3.nl

Please enter a semicolon-separated list of IP addresses. The Exim SMTP listener daemon will
listen on all IP addresses listed here.

An empty value will cause Exim to listen for connections on all available network interfaces.

If this system only receives mail directly from local services (and not from other hosts), it is
suggested to prohibit external connections to the local Exim daemon. Such services include
e-mail programs (MUAs) which talk to localhost only as well as fetchmail. External connections
are impossible when 127.0.0.1 is entered here, as this will disable listening on public network
interfaces.

IP-addresses to listen on for incoming SMTP connections: 

Please enter a semicolon-separated list of recipient domains for which this machine should
consider itself the final destination. These domains are commonly called 'local domains'. The
local hostname (8b810ce9eb73) and 'localhost' are always added to the list given here.

By default all local domains will be treated identically. If both a.example and b.example are
local domains, acc@a.example and acc@b.example will be delivered to the same final destination.
If different domain names should be treated differently, it is necessary to edit the config
files afterwards.

Other destinations for which mail is accepted: 

Please enter a semicolon-separated list of recipient domains for which this system will relay
mail, for example as a fallback MX or mail gateway. This means that this system will accept mail
for these domains from anywhere on the Internet and deliver them according to local delivery
rules.

Do not mention local domains here. Wildcards may be used.

Domains to relay mail for: hull.studlab.os3.nl : mulhouse.studlab.os3.nl

Please enter a semicolon-separated list of IP address ranges for which this system will
unconditionally relay mail, functioning as a smarthost.

You should use the standard address/prefix format (e.g. 194.222.242.0/24 or
5f03:1200:836f::/48).

If this system should not be a smarthost for any other host, leave this list blank.

Machines to relay mail for: 172.16.0.0/12

In normal mode of operation Exim does DNS lookups at startup, and when receiving or delivering
messages. This is for logging purposes and allows keeping down the number of hard-coded values
in the configuration.

If this system does not have a DNS full service resolver available at all times (for example if
its Internet access is a dial-up line using dial-on-demand), this might have unwanted
consequences. For example, starting up Exim or running the queue (even with no messages waiting)
might trigger a costly dial-up-event.

This option should be selected if this system is using Dial-on-Demand. If it has always-on
Internet access, this option should be disabled.

Keep number of DNS-queries minimal (Dial-on-Demand)? [yes/no] no

Exim is able to store locally delivered email in different formats. The most commonly used ones
are mbox and Maildir. mbox uses a single file for the complete mail folder stored in /var/mail/.
With Maildir format every single message is stored in a separate file in ~/Maildir/.

Please note that most mail tools in Debian expect the local delivery method to be mbox in their
default.

  1. mbox format in /var/mail/  2. Maildir format in home directory
Delivery method for local mail: 2

The Debian exim4 packages can either use 'unsplit configuration', a single monolithic file
(/etc/exim4/exim4.conf.template) or 'split configuration', where the actual Exim configuration
files are built from about 50 smaller files in /etc/exim4/conf.d/.

Unsplit configuration is better suited for large modifications and is generally more stable,
whereas split configuration offers a comfortable way to make smaller modifications but is more
fragile and might break if modified carelessly.

A more detailed discussion of split and unsplit configuration can be found in the
Debian-specific README files in /usr/share/doc/exim4-base.

Split configuration into small files? [yes/no] no

Mail for the 'postmaster', 'root', and other system accounts needs to be redirected to the user
account of the actual system administrator.

If this value is left empty, such mail will be saved in /var/mail/mail, which is not
recommended.

Note that postmaster's mail should be read on the system to which it is directed, rather than
being forwarded elsewhere, so (at least one of) the users listed here should not redirect their
mail off this machine. A 'real-' prefix can be used to force local delivery.

Multiple user names need to be separated by spaces.

Root and postmaster mail recipient: os3student

</code>

Which generated:
<code>
root@8b810ce9eb73:/etc/exim4# grep -r os3 / 2> /dev/null                                         
/etc/resolv.conf:search studlab.os3.nl
/etc/mailname:nevers.studlab.os3.nl
/etc/exim4/update-exim4.conf.conf:dc_relay_domains='hull.studlab.os3.nl : mulhouse.studlab.os3.nl'
/etc/aliases:root: os3student
/proc/kallsyms:0000000000000000 t dmi_smbios3_present
^C
root@8b810ce9eb73:/etc/exim4# cat /etc/mailname 
nevers.studlab.os3.nl
root@8b810ce9eb73:/etc/exim4# cat /etc/aliases 
# /etc/aliases
mailer-daemon: postmaster
postmaster: root
nobody: root
hostmaster: root
usenet: root
news: root
webmaster: root
www: root
ftp: root
abuse: root
noc: root
security: root
root: os3student
root@8b810ce9eb73:/etc/exim4# cat /etc/exim4/update-exim4.conf.conf 
# /etc/exim4/update-exim4.conf.conf
#
# Edit this file and /etc/mailname by hand and execute update-exim4.conf
# yourself or use 'dpkg-reconfigure exim4-config'
#
# Please note that this is _not_ a dpkg-conffile and that automatic changes
# to this file might happen. The code handling this will honor your local
# changes, so this is usually fine, but will break local schemes that mess
# around with multiple versions of the file.
#
# update-exim4.conf uses this file to determine variable values to generate
# exim configuration macros for the configuration file.
#
# Most settings found in here do have corresponding questions in the
# Debconf configuration, but not all of them.
#
# This is a Debian specific file

dc_eximconfig_configtype='internet'
dc_other_hostnames=''
dc_local_interfaces=''
dc_readhost=''
dc_relay_domains='hull.studlab.os3.nl : mulhouse.studlab.os3.nl'
dc_minimaldns='false'
dc_relay_nets='172.16.0.0/12'
dc_smarthost=''
CFILEMODE='644'
dc_use_split_config='false'
dc_hide_mailname=''
dc_mailname_in_oh='true'
dc_localdelivery='maildir_home'
</code>
This
[[http://www.learnlinux.org.za/courses/build/electives/ch04s02.html|three files]]
contain the config.

We saw in the
[[https://hub.docker.com/r/os3nl/exim/builds/bwmxkpc8jxznyluabhnazxs/|buildlog]]:
<code>
cp: can't create '/etc/mail/aliases': No such file or directory
</code>
So we moved aliases and mailname to /etc/mail.


DNS records:
<code>
nevers.prac.os3.nl. IN MX 10 nevers.prac.os3.nl.
nevers.prac.os3.nl. IN MX 20 mulhouse.prac.os3.nl.
nevers.prac.os3.nl. IN MX 30 hull.prac.os3.nl.
</code>


=== Q3.  ===
== a. Add a local account on your experimental machine and make sure that the MTA can deliver mail to it Show the required configuration  == 

The config settings before the acl part of the default config:
<code>
primary_hostname = nevers.prac.os3.nl
domainlist local_domains = @ : nevers.prac.os3.nl
domainlist relay_to_domains = hull.prac.os3.nl : mulhouse.prac.os3.nl
hostlist   relay_from_hosts = localhost : 172.16.0.0/12 : 192.168.0.0/16 : hull.prac.os3.nl : mulhouse.prac.os3.nl
acl_smtp_rcpt = acl_check_rcpt
acl_smtp_data = acl_check_data
daemon_smtp_ports = 25
host_lookup = *
prdr_enable = true
log_selector = +smtp_protocol_error +smtp_syntax_error \
	+tls_certificate_verified

</code>
The remaining of the file is the default config of exim.
See the full config file [[https://github.com/os3nl/exim/blob/master/exim.conf|here]].

We needed a user:
<code>
2018-10-09 12:29:48 1g9r5b-00000C-OC ** os3student@nevers.prac.os3.nl <postmaster@nevers.prac.os3.nl>: Unknown user
</code>

So I initially deleted the alias from root to student, but:
<code>
2018-10-09 12:26:16 1g9r5b-00000C-OC <= test@tools.wormly.com H=tools.wormly.com [96.126.113.160] P=esmtps X=TLSv1:DHE-RSA-AES256-SHA:256 CV=no S=747 id=94ec847455c7a2fbfa0afed33c231fd6@blog.wormly.com
2018-10-09 12:26:16 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-09 12:26:16 1g9r5b-00000C-OC User 0 set for local_delivery transport is on the fixed_never_users list
2018-10-09 12:26:16 1g9r5b-00000C-OC == root@nevers.prac.os3.nl <postmaster@nevers.prac.os3.nl> R=localuser T=local_delivery defer (-29): User 0 set for local_delivery transport is on the fixed_never_users list
</code>
But during compiling it made root not allowed as a user (fixed_never_users).

So we did:
<code>
adduser -D os3student
</code>

But this was not enough:
<code>
2018-10-09 12:36:45 1g9rFk-00000U-QH == os3student@nevers.prac.os3.nl <postmaster@nevers.prac.os3.nl> R=localuser T=local_delivery defer (13): Permission denied: failed to create directories for /var/mail: Permission denied

mkdir -p /var/mail/os3student
</code>

And later we got desperate:
<code>
2018-10-09 12:38:28 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-09 12:38:28 1g9rHP-00000b-PM == os3student@nevers.prac.os3.nl <postmaster@nevers.prac.os3.nl> R=localuser T=local_delivery defer (13): Permission denied: creating lock file hitching post /var/mail/os3student.lock.nevers.prac.os3.nl.5bbca144.00000028 (euid=1000 egid=1000)

chmod 777 /var/mail

2018-10-09 12:39:55 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-09 12:39:55 1g9rIo-00000h-Or == os3student@nevers.prac.os3.nl <postmaster@nevers.prac.os3.nl> R=localuser T=local_delivery defer (-6): mailbox /var/mail/os3student has wrong uid (0 != 1000)

chown os3student:os3student /var/mail/os3student

2018-10-09 12:42:35 1g9rLP-00000s-3R == os3student@nevers.prac.os3.nl <postmaster@nevers.prac.os3.nl> R=localuser T=local_delivery defer (-4): mailbox /var/mail/os3student has too many links (2)

rm -r /var/mail/os3student

2018-10-09 12:45:00 1g9rNj-000019-PV => os3student <postmaster@nevers.prac.os3.nl> R=localuser T=local_delivery
2018-10-09 12:45:00 1g9rNj-000019-PV Completed
</code>
At the end, we received an email!

== b. Add to your log an email received by this account Do not forget the full headers  ==

<code>
/var/mail # cat os3student 
From test@tools.wormly.com Tue Oct 09 12:45:00 2018
Return-path: <test@tools.wormly.com>
Envelope-to: postmaster@nevers.prac.os3.nl
Delivery-date: Tue, 09 Oct 2018 12:45:00 +0000
Received: from tools.wormly.com ([96.126.113.160])
        by nevers.prac.os3.nl with esmtps (TLSv1:DHE-RSA-AES256-SHA:256)
        (Exim 4.91)
        (envelope-from <test@tools.wormly.com>)
        id 1g9rNj-000019-PV
        for postmaster@nevers.prac.os3.nl; Tue, 09 Oct 2018 12:45:00 +0000
Date: Tue, 9 Oct 2018 12:44:58 +0000
To: postmaster@nevers.prac.os3.nl
From: Wormly SMTP Test <test@tools.wormly.com>
Subject: Wormly SMTP Test Message
Message-ID: <d94a10d7734a6e082bed22fbafe3e4ce@blog.wormly.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1

This message was sent using the Wormly SMTP testing tool by this user:
Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36
145.109.39.37
</code>
Send by [[https://www.wormly.com/test-smtp-server|this]] online tool.

== c. Also make sure that any email intended for postmaster city prac os3 nl is delivered to this account Show the full email as delivered to the new account and the required configuration  == 

The aliases file makes postmaster point to root, and root point to os3student:
<code>
mailer-daemon: postmaster
postmaster: root
nobody: root
hostmaster: root
usenet: root
news: root
webmaster: root
www: root
ftp: root
abuse: root
noc: root
security: root
root: os3student
</code>

Which is who we emailed in the question b.


=== Q4. First describe you have done on your own server to create two backup MTAs for your domain Please do not describe how you made your server fallback for the other domains at the same time that is the next question This makes grading easier for the lab teachers  ===

As seen in the config, we added the two others (with higher value, so lower prio) to DNS.
The config is included in Q6 and
[[https://github.com/os3nl/bind/commit/3c479a26df3e7af89d9c4df51b26a96b51c540cb|this]]
is the last commit msg.


=== Q5. Afterwards describe what you have done on your own server to make it act as a backup for the two other domains  ===

On my own server, I allow relaying in my exim config
But we read later that this was not the solution,
it needed extra localdomains in my exim config.

=== Q6. Shutdown your MTA send a mail to your domain and show  ===

<code>
docker-compose stop
Stopping exim_exim_1 ... done
</code>

after many failes, it was a DNS problem:
<code>
;; ANSWER SECTION:
nevers.prac.os3.nl.     60      IN      MX      30 hull.prac.os3.nl.
nevers.prac.os3.nl.     60      IN      MX      10 nevers.prac.os3.nl.
nevers.prac.os3.nl.     60      IN      MX      21 mail.mulhouse.prac.os3.nl.
nevers.prac.os3.nl.     60      IN      MX      31 mail.hull.prac.os3.nl.
nevers.prac.os3.nl.     60      IN      MX      20 mulhouse.prac.os3.nl.
</code>

Since Kees was gone and David his server said error 550 (recepient denied),
I set up my own second(ary) server..

DNS
<code>
nevers.prac.os3.nl. IN MX 10 nevers.prac.os3.nl.
mail.nevers.prac.os3.nl. IN CNAME nevers.prac.os3.nl. ; for kees
nevers.prac.os3.nl. IN MX 11 secondary.nevers.prac.os3.nl.
nevers.prac.os3.nl. IN MX 20 mulhouse.prac.os3.nl.
nevers.prac.os3.nl. IN MX 21 mail.mulhouse.prac.os3.nl.
nevers.prac.os3.nl. IN MX 30 hull.prac.os3.nl.
nevers.prac.os3.nl. IN MX 31 mail.hull.prac.os3.nl.
</code>

Having two, shutting down one:
<code>
root@nevers:~/exim# docker-compose ps
    Name                   Command               State             Ports           
-----------------------------------------------------------------------------------
exim_backup_1   sh -c chmod 777 /var/mail; ...   Up      145.100.111.10:25->25/tcp 
exim_exim_1     sh -c chmod 777 /var/mail; ...   Up      145.100.104.117:25->25/tcp
root@nevers:~/exim# docker-compose stop exim
Stopping exim_exim_1 ... done
</code>

When sending an email we get:
<code>
~ # ls -alh /var/log/exim/mainlog 
-rw-r-----    1 exim     exim       53.0K Oct  9 19:38 /var/log/exim/mainlog
~ # tail /var/log/exim/mainlog 
2018-10-09 19:38:58 1g9xqL-00003z-Ut => postmaster@nevers.prac.os3.nl R=dnslookup T=remote_smtp H=secondary.nevers.prac.os3.nl [145.100.111.10] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 10625 byte chunk, total 18844\\n250 OK id=1g9xqM-000043-3e"
2018-10-09 19:38:58 1g9xqL-00003z-Ut Completed
2018-10-09 19:38:58 1g9xqM-000043-3e [145.100.111.10] SSL verify error: depth=0 error=self signed certificate cert=/C=UK/O=Exim Developers/CN=secondary.nevers.prac.os3.nl
2018-10-09 19:38:58 1g9xqM-000047-97 <= <> H=nevers.local (secondary.nevers.prac.os3.nl) [172.20.0.1] P=esmtps X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K S=19008 id=E1g9xqH-00002A-1c@secondary.nevers.prac.os3.nl
2018-10-09 19:38:58 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-09 19:38:58 1g9xqM-000047-97 ** postmaster@nevers.prac.os3.nl: Too many "Received" headers - suspected mail loop
2018-10-09 19:38:58 1g9xqM-000047-97 Frozen (delivery error message)
2018-10-09 19:38:58 1g9xqM-000043-3e => postmaster@nevers.prac.os3.nl R=dnslookup T=remote_smtp H=secondary.nevers.prac.os3.nl [145.100.111.10] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 10625 byte chunk, total 19115\\n250 OK id=1g9xqM-000047-97"
2018-10-09 19:38:58 1g9xqM-000043-3e Completed
</code>
Indeed a loop.

So we sent from an external source
and see in our logs:
<code>
root@nevers:~/bind/lab4# docker exec -it exim_backup_1 sh                                                
/ # tail /var/log/exim/mainlog 
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-10 06:11:36 1gA7ia-00008b-DD => postmaster@nevers.prac.os3.nl R=dnslookup T=remote_smtp H=secondary.nevers.prac.os3.nl [145.100.111.10] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 3887 byte chunk, total 12078\\n250 OK id=1gA7ia-00008f-IW"
2018-10-10 06:11:36 1gA7ia-00008b-DD Completed
2018-10-10 06:11:36 1gA7ia-00008i-M0 <= <> R=1gA7ia-00008f-IW U=exim P=local S=13382
2018-10-10 06:11:36 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-10 06:11:36 1gA7ia-00008i-M0 H=aspmx.l.google.com [2a00:1450:4013:c07::1b] Address not available
2018-10-10 06:11:36 1gA7ia-00008f-IW Completed
2018-10-10 06:11:38 1gA7ia-00008i-M0 => sanderlentink@mdmail.nl R=dnslookup T=remote_smtp H=aspmx.l.google.com [173.194.79.26] X=TLSv1.2:ECDHE-RSA-CHACHA20-POLY1305:256 CV=yes K C="250 2.0.0 OK a36-v6si16944297edd.80 - gsmtp"
2018-10-10 06:11:38 1gA7ia-00008i-M0 Completed
</code>

Now we turn on our main server and wait for a moment:
<code>
root@nevers:~/exim# docker-compose start exim
Starting exim ... done
root@nevers:~/exim# docker exec -it exim_exim_1 sh
/ # tail /var/log/exim/mainlog 
 Suggested action: use keep_environment.
2018-10-10 06:13:41 exim 4.91 daemon started: pid=1, -q15m, listening for SMTP on port 25 (IPv6 and IPv4)
2018-10-10 06:13:41 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-10 06:13:41 Start queue run: pid=11
2018-10-10 06:13:41 End queue run: pid=11
2018-10-10 06:20:02 H=hull.studlab.os3.nl (mail.pickering.hull.prac.os3.nl) [145.100.104.167] sender verify defer for <dgaray@mail.pickering.hull.prac.os3.nl>: host lookup did not complete
2018-10-10 06:20:02 H=hull.studlab.os3.nl (mail.pickering.hull.prac.os3.nl) [145.100.104.167] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no F=<dgaray@mail.pickering.hull.prac.os3.nl> temporarily rejected RCPT <test@nevers.prac.os3.nl>: Could not complete sender verify
2018-10-10 06:20:14 H=mulhouse.studlab.os3.nl (mail.mulhouse.prac.os3.nl) [145.100.104.115] sender verify defer for <dgaray@mail.pickering.hull.prac.os3.nl>: host lookup did not complete
2018-10-10 06:20:14 H=mulhouse.studlab.os3.nl (mail.mulhouse.prac.os3.nl) [145.100.104.115] F=<dgaray@mail.pickering.hull.prac.os3.nl> temporarily rejected RCPT <test@nevers.prac.os3.nl>: Could not complete sender verify
</code>
From which the most important part:
<code>
temporarily rejected RCPT <test@nevers.prac.os3.nl>: Could not complete sender verify
</code>

When shutting down our main again,
we test with another
[[https://www.ultratools.com/tools/emailTestResult|website]],
which output:
<code>
MX Record Target: 10 nevers.prac.os3.nl.
IP address: 145.100.104.117 (netherlands)
Status: Connect failed
Test duration(ms): Timed out...

MX Record Target: 11 secondary.nevers.prac.os3.nl
.IP address: 145.100.111.10 (netherlands)
Status: Success
Test duration(ms): 3225

MX Record Target: 20 mulhouse.prac.os3.nl.
MX Record Target: 21 mail.mulhouse.prac.os3.nl.
IP address: 145.100.104.115 (netherlands)
Status: Connect failed
Test duration(ms): Timed out...

MX Record Target: 30 hull.prac.os3.nl.
MX Record Target: 31 mail.hull.prac.os3.nl.
IP address: 145.100.104.167 (netherlands)
Status: Connect failed
Test duration(ms): Timed out...
</code>

So we send an email:
<code>
root@nevers:~/exim# docker-compose stop exim
Stopping exim_exim_1 ... done
root@nevers:~/exim# docker exec -it exim_backup_1 sh
/ # cat /var/log/exim/mainlog 
. . .
2018-10-10 11:46:49 1gACwz-000029-Lx <= sanderlentink@mdmail.nl H=nevers.local (secondary.nevers.prac.os3.nl) [172.20.0.1] P=esmtps X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K S=12153 id=CAMU2pL8W6bU3n2rxB995vH4curw7A+S5kyVyD9-T0zASPsgh6Q@mail.gmail.com
2018-10-10 11:46:49 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-10 11:46:49 1gACwz-000029-Lx ** postmaster@nevers.prac.os3.nl: Too many "Received" headers - suspected mail loop
2018-10-10 11:46:49 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-10 11:46:49 1gACwz-000025-Fp => postmaster@nevers.prac.os3.nl R=dnslookup T=remote_smtp H=secondary.nevers.prac.os3.nl [145.100.111.10] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 3886 byte chunk, total 12077\\n250 OK id=1gACwz-000029-Lx"
2018-10-10 11:46:49 1gACwz-000025-Fp Completed
2018-10-10 11:46:49 1gACwz-00002C-Ph <= <> R=1gACwz-000029-Lx U=exim P=local S=13380
2018-10-10 11:46:49 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-10 11:46:49 1gACwz-00002C-Ph H=aspmx.l.google.com [2a00:1450:4013:c00::1a] Address not available
2018-10-10 11:46:49 1gACwz-000029-Lx Completed
2018-10-10 11:46:51 1gACwz-00002C-Ph => sanderlentink@mdmail.nl R=dnslookup T=remote_smtp H=aspmx.l.google.com [108.177.126.27] X=TLSv1.2:ECDHE-RSA-CHACHA20-POLY1305:256 CV=yes K C="250 2.0.0 OK f20-v6si5665338edt.166 - gsmtp"
2018-10-10 11:46:51 1gACwz-00002C-Ph Completed
</code>

We see that the retry on our backup server has been updated:
<code>
/ # find / -name exim
/etc/conf.d/exim
/etc/logrotate.d/exim
/etc/init.d/exim
/etc/exim
/var/spool/exim
/var/log/exim
/usr/lib/exim
/usr/sbin/exim
/ # cd /var/spool/exim
/var/spool/exim # ls -al
total 20
drwxr-x---    5 exim     exim          4096 Oct 10 11:46 .
drwxr-xr-x    1 root     root          4096 Oct 10 11:40 ..
drwxr-x---    2 exim     exim          4096 Oct 10 11:46 db
drwxr-x---    2 exim     exim          4096 Oct 10 11:46 input
drwxr-x---    2 exim     exim          4096 Oct 10 11:46 msglog
/var/spool/exim # cd msglog
/var/spool/exim/msglog # ls -al
total 8
drwxr-x---    2 exim     exim          4096 Oct 10 11:46 .
drwxr-x---    5 exim     exim          4096 Oct 10 11:46 ..
/var/spool/exim/msglog # cd ..
/var/spool/exim # cd db
/var/spool/exim/db # ls -al
total 24
drwxr-x---    2 exim     exim          4096 Oct 10 11:46 .
drwxr-x---    5 exim     exim          4096 Oct 10 11:46 ..
-rw-r-----    1 exim     exim         12288 Oct 10 11:46 retry
-rw-r-----    1 exim     exim             0 Oct 10 11:46 retry.lockfile
-rw-r-----    1 exim     exim         12288 Oct 10 11:46 wait-remote_smtp
-rw-r-----    1 exim     exim             0 Oct 10 11:46 wait-remote_smtp.lockfile
</code>
We see that the modification time is the same as we saw in our log.

I overlooked something:
<code>
2018-10-10 12:19:47 H=mulhouse.studlab.os3.nl (mail.mulhouse.prac.os3.nl) [145.100.104.115] sender verify defer for <dgaray@mail.pickering.hull.prac.os3.nl>: host lookup did not complete
</code>

So we updated the DNS,
the IP lookup is
[[https://github.com/os3nl/bind/blob/7848449a816d1b02e391f5ece4ec02c93480c914/myzone.conf|added]].
And used another IP:
<code>
ip a a 145.100.111.9 dev eno1
</code>


<code>
2018-10-10 13:11:30 1gAEGw-00002G-6Q Completed
2018-10-10 13:11:30 1gAEGw-00002K-D6 [145.100.111.10] SSL verify error: depth=0 error=self signed certificate cert=/C=UK/O=Exim Developers/CN=secondary.nevers.prac.os3.nl
2018-10-10 13:11:30 1gAEGw-00002O-JP <= sanderlentink@mdmail.nl H=nevers.local (secondary.nevers.prac.os3.nl) [172.20.0.1] P=esmtps X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K S=12147 id=CAMU2pL_knDfVfhcXRt2xOmC5LVFLgO2Mm-rj1Gj=gU7REy5Z4g@mail.gmail.com
2018-10-10 13:11:30 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-10 13:11:30 1gAEGw-00002O-JP ** postmaster@nevers.prac.os3.nl: Too many "Received" headers - suspected mail loop
2018-10-10 13:11:30 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-10 13:11:30 1gAEGw-00002K-D6 => postmaster@nevers.prac.os3.nl R=dnslookup T=remote_smtp H=secondary.nevers.prac.os3.nl [145.100.111.10] X=TLSv1.2:ECDHE-RSA-AES256-GCM-SHA384:256 CV=no K C="250- 3879 byte chunk, total 12070\\n250 OK id=1gAEGw-00002O-JP"
2018-10-10 13:11:30 1gAEGw-00002K-D6 Completed
2018-10-10 13:11:30 1gAEGw-00002R-Mh <= <> R=1gAEGw-00002O-JP U=exim P=local S=13374
2018-10-10 13:11:30 Warning: No server certificate defined; will use a selfsigned one.
 Suggested action: either install a certificate or change tls_advertise_hosts option
2018-10-10 13:11:30 1gAEGw-00002R-Mh H=aspmx.l.google.com [2a00:1450:4013:c04::1a] Address not available
2018-10-10 13:11:30 1gAEGw-00002O-JP Completed
2018-10-10 13:11:31 1gAEGw-00002R-Mh => sanderlentink@mdmail.nl R=dnslookup T=remote_smtp H=aspmx.l.google.com [173.194.69.27] X=TLSv1.2:ECDHE-RSA-CHACHA20-POLY1305:256 CV=yes K C="250 2.0.0 OK d19-v6si5585723ejj.256 - gsmtp"
2018-10-10 13:11:31 1gAEGw-00002R-Mh Completed
</code>

To fight the host lookup msg in the logs and allow test websites we use:
<code>
hostlist   relay_from_hosts = 0.0.0.0/0
#host_lookup = *
domainlist local_domains = secondary.nevers.prac.os3.nl : nevers.prac.os3.nl
</code>

== a. The email is delivered to one of your colleaques  == 

We end with:
<code>
root@nevers:~/exim# docker exec -it exim_backup_1 cat /var/mail/os3student
From svlentink@gmail.com Thu Oct 11 12:16:00 2018
Return-path: <svlentink@gmail.com>
Envelope-to: postmaster@nevers.prac.os3.nl
Delivery-date: Thu, 11 Oct 2018 12:16:00 +0000
Received: from [209.85.208.180] (helo=mail-lj1-f180.google.com)
        by secondary.nevers.prac.os3.nl with esmtps (TLSv1.2:ECDHE-RSA-AES128-GCM-SHA256:128)
        (Exim 4.91)
        (envelope-from <svlentink@gmail.com>)
        id 1gAZsm-00000E-JO
        for postmaster@nevers.prac.os3.nl; Thu, 11 Oct 2018 12:16:00 +0000
Received: by mail-lj1-f180.google.com with SMTP id u21-v6so7984334lja.8
        for <postmaster@nevers.prac.os3.nl>; Thu, 11 Oct 2018 05:16:00 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=mime-version:from:date:message-id:subject:to;
        bh=ny+g4e/micnZNhkomWRO8juf9DB22RUocUfigCLaXww=;
        b=KbDukoDhJbgtJGi6/nVIZRqwE2IVQttk0n47xoIWZrrpUDB+19cMzBFBmcg7rCmKV0
         rjcNlPeCXRiHDWSmYaGk84QzqhtEQtUoW8MLy7b/K4dsIq3QMRgr63QziiXpFvSeqqdj
         LZLkp6LT8uRlLRDb0UNNShX5rE+vmI+c4lZELr6h2ye0M1GQmvxClORxutg+zHcmuGth
         lWG6SG+wP2C2/qnJ+1X3Xsf1Q8CS0kJL9WFC2mbtdii+TATcRRiBE6t4aGVyyejzJX+G
         FCSB8uvrKocMXdtHl20Fo9bJPaKVttIPa5KxnIqQpRv33w47uqn6wAhse3o81aQJd/gA
         N3Fg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:mime-version:from:date:message-id:subject:to;
        bh=ny+g4e/micnZNhkomWRO8juf9DB22RUocUfigCLaXww=;
        b=NZJ7xTgWGKWwNTGXdxajkTV0RGZOVZMG62g7E6yMNxf+5UAI05fy7fO0RuBqlVCplx
         F4PW9Oau7YUg4lqmfWc/mhtHSO/tHaEVXnHznQqR6QsmPSde+HXqG0V8MINlenbQVS6u
         KD5Z8/pyPytfVutaeGsL/9oxZ4FFVnyona1AZsRK+y3t8QI2rkSCPdRCQLc9hQ0t8mYF
         92zBWQrhzPM5++MbTv8s4YBgedFst5SmnxbYMmVBUr3CMjGJa1j6pStgIb2SYirClggr
         fu54kaAaA2sd/BDH7Xfdc8yqAqjlvo/U2cbsMLU1qFMsyojMlnDkVwQRL/kF9IStjIXc
         SoEw==
X-Gm-Message-State: ABuFfoiRRpKfZWbkWU1Nba0jO6hb54Euuc1qbPEv9p8mOt96UWyVGmY9
        8RmnwpkO71MoIbJ3nBeZ6oiOaJmjDPXQOu6Vaq8J0A==
X-Google-Smtp-Source: ACcGV624o4tiwCRSU59nnJXetTt1e8qAYWfIYVsAFOqk/JWR4jx4T4ZKLmlX5oo17cZH1N9qW2nsB4zuTUwyvEm+WZE=
X-Received: by 2002:a2e:8797:: with SMTP id n23-v6mr1053638lji.173.1539260159381;
 Thu, 11 Oct 2018 05:15:59 -0700 (PDT)
MIME-Version: 1.0
From: Sander Lentink <svlentink@gmail.com>
Date: Thu, 11 Oct 2018 14:15:47 +0200
Message-ID: <CAM=p=-XFUfwA-3nFY6RCTDmWQ+0GMFDzMySLEtgbKpUM_X-DVg@mail.gmail.com>
Subject: test
To: postmaster@nevers.prac.os3.nl
Content-Type: multipart/alternative; boundary="0000000000000454920577f2efbe"

--0000000000000454920577f2efbe
Content-Type: text/plain; charset="UTF-8"

aabb
Yours sincerely / Met vriendelijke groet,

Sander Lent.ink <http://lent.ink>
0031617012655

--0000000000000454920577f2efbe
Content-Type: text/html; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable

<div dir=3D"ltr">aabb<br clear=3D"all"><div><div dir=3D"ltr" class=3D"gmail=
_signature" data-smartmail=3D"gmail_signature"><div dir=3D"ltr"><div><div d=
ir=3D"ltr">Yours sincerely / Met vriendelijke groet,<br>
<br>
Sander=C2=A0<a href=3D"http://lent.ink" target=3D"_blank">Lent.ink</a><br>
0031617012655</div></div></div></div></div></div>

--0000000000000454920577f2efbe--
</code>

The issue was: confusion...
I thought the intended behaviour was that the backup mailserver would accept the mail,
store it in its queue.
That the relay config option did this.
However, the relay does not do this, it just relays,
for which the receiving party needs to be online.
It is not all that hard, we just needed the second localdomain added,
so it was able to store for the other domain,
just like the question stated:
"backup MTAs will receive email intended for your domain".
This was all my bad.
The pointer records I installed were nice, but not needed.

But to recap the requirements:
we let all the server accept (localdomains) for all domains
and have the appropriate aliases in place.
This also ment that I created the user(s).

Reverse lookup (PTR) is not needed, but nice to have.
We need the right MX and A records, mine were:
<code>
secondary.nevers.prac.os3.nl. IN A 145.100.111.10 ; glue

; mail labs:
mailserver.nevers.prac.os3.nl. IN A 145.100.111.9
nevers.prac.os3.nl. IN MX 10 mailserver.nevers.prac.os3.nl.
mail.nevers.prac.os3.nl. IN CNAME nevers.prac.os3.nl. ; for kees
nevers.prac.os3.nl. IN MX 11 secondary.nevers.prac.os3.nl.
secondary.nevers.prac.os3.nl. IN MX 0 secondary.nevers.prac.os3.nl.
nevers.prac.os3.nl. IN MX 20 mulhouse.prac.os3.nl.
nevers.prac.os3.nl. IN MX 21 mail.mulhouse.prac.os3.nl.
nevers.prac.os3.nl. IN MX 30 hull.prac.os3.nl.
nevers.prac.os3.nl. IN MX 31 mail.hull.prac.os3.nl.
</code>

This was the docker-compose.yml:
<code>
version: '3'
services:
  exim:
    image: exim
    ports:
      - '145.100.111.9:25:25' #make sure 'dig -x IP' works!
    volumes:
      - $PWD/exim.conf:/etc/exim/exim.conf:ro
      - $PWD/aliases:/etc/mail/aliases:ro
      - $PWD/mailname:/etc/mail/mailname:ro
    entrypoint: ["sh","-c"]
    command: ["mkdir -p /var/mail; chmod 777 /var/mail; adduser -D os3student; /usr/sbin/exim -bdf -q15m"]
  backup:
    image: exim
    ports:
      - '145.100.111.10:25:25'
    volumes:
      - $PWD/exim2.conf:/etc/exim/exim.conf:ro
      - $PWD/aliases:/etc/mail/aliases:ro
      - $PWD/mailname2:/etc/mail/mailname:ro
    entrypoint: ["sh","-c"]
    command: ["mkdir -p /var/mail; chmod 777 /var/mail; adduser -D os3student; /usr/sbin/exim -bdf -q15m"]

</code>

== b. The email is delivered to your MTA when you turn it back on  == 
When we turn the main back on,
it receives new sent messages,
not the messages received by backup when mine was done,
this needs to be synced afterwards.
But a better option would be to have NFS, CepFS or GlusterFS,
that this is not needed.
For my docker setup,
this is not needed,
I can just let both the primary and the backup point to the same storage directory/
docker volume.


The email works again,
since it has a higher priority (lower number) in the DNS.
<code>
root@nevers:~/exim# docker exec -it exim_exim_1 cat /var/mail/os3student                              
From svlentink@gmail.com Thu Oct 11 11:15:22 2018
Return-path: <svlentink@gmail.com>
Envelope-to: postmaster@nevers.prac.os3.nl
Delivery-date: Thu, 11 Oct 2018 11:15:22 +0000
Received: from [209.85.208.174] (helo=mail-lj1-f174.google.com)
        by nevers.prac.os3.nl with esmtps (TLSv1.2:ECDHE-RSA-AES128-GCM-SHA256:128)
        (Exim 4.91)
        (envelope-from <svlentink@gmail.com>)
        id 1gAYw5-00000G-Vm
        for postmaster@nevers.prac.os3.nl; Thu, 11 Oct 2018 11:15:22 +0000
Received: by mail-lj1-f174.google.com with SMTP id u21-v6so7820623lja.8
        for <postmaster@nevers.prac.os3.nl>; Thu, 11 Oct 2018 04:15:21 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=mime-version:from:date:message-id:subject:to;
        bh=J5KFOiX+XyriXPtQSxd6z5vXLIG6Oli8a6JmfUjaOc0=;
        b=sU+uipkj2S7oQlt10/iktwWUQmvijgqD1RUBoABOG1Icf79QS02wdi2U24nUQIWTDL
         OY1HjNWE3Wd9morEsgULDNGxM010gLdMr8+S7rFSPUVYak4P6hpbmNblD/pfjRZMJQnS
         uA4X0lSzZ60IFlK60pRf+F0dieaOe059/prBz97Zp16G0DV5gJCtDjTEC2vsh+PkMnN5
         UBhJMK4B+3ltS5+9UgZZcCvaQVc/sPpWrU7EI5tDiXVKAI6Y48+BOAtxgXILsokh7YeA
         9zBz6sGlTM6yddPx0RuaZfZQlqve4h6eF7beFOOEju3u7s4SQyMz8Xndzl7JxrUbg1IF
         fFoQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:mime-version:from:date:message-id:subject:to;
        bh=J5KFOiX+XyriXPtQSxd6z5vXLIG6Oli8a6JmfUjaOc0=;
        b=ruAXGbVagGrrJaec4hydGT1/f7f7VV3yl1sAVygIi+V/IFa5mijcISe90TkwVuqDD0
         TuLkKNXo04XK++EhIOjBVsZOZO8/uOirPsFGCtySSbt3IagqOPV2HkV146U6T6+XcbHj
         S2gVxhyhwVfUEpqtBFnbICZrRwkWkEMrUZPKB3n/iFw6IkhkYyjVFuxd7x33RyC5GHRr
         xDK3HKL0n37VhQRn3Nyin/rNNbTcHRIQtdYPf5Ghh0307zHYKf+WoOGfZ2y61q+wjkw1
         /smIXPxvYIAYq3yB2Ws2c14eyskvBqn8p7gvdLjgn7XR+tHdzdjlnogeP+lHO+wbzoFO
         TlGA==
X-Gm-Message-State: ABuFfoiXHPKE/8OJypvdjOgLj2tVH4oHEdvjZRgDspz4K/Uo+a2sJFkO
        LnxMZJjcYPS3uIjj2pQqe3OhcQ/b5iGxFoxqxGKk4w==
X-Google-Smtp-Source: ACcGV62yUeI9TQMxYttNWTlxfcTvZCSgsqBEwRVoTrxdNTI0pJ0xl11vcmvbrpCamtzhLBe+tNufEqDbumKaEDkX+Tk=
X-Received: by 2002:a2e:1510:: with SMTP id s16-v6mr918359ljd.4.1539256520980;
 Thu, 11 Oct 2018 04:15:20 -0700 (PDT)
MIME-Version: 1.0
From: Sander Lentink <svlentink@gmail.com>
Date: Thu, 11 Oct 2018 13:15:09 +0200
Message-ID: <CAM=p=-USY24tz_mBhZr8SWWSMk46G6qZK9HJ+mczOim1mokO4w@mail.gmail.com>
Subject: tes
To: postmaster@nevers.prac.os3.nl
Content-Type: multipart/alternative; boundary="00000000000026c18f0577f2162c"

--00000000000026c18f0577f2162c
Content-Type: text/plain; charset="UTF-8"

t
Yours sincerely / Met vriendelijke groet,

Sander Lent.ink <http://lent.ink>
0031617012655

--00000000000026c18f0577f2162c
Content-Type: text/html; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable

<div dir=3D"ltr">t<br clear=3D"all"><div><div dir=3D"ltr" class=3D"gmail_si=
gnature" data-smartmail=3D"gmail_signature"><div dir=3D"ltr"><div><div dir=
=3D"ltr">Yours sincerely / Met vriendelijke groet,<br>
<br>
Sander=C2=A0<a href=3D"http://lent.ink" target=3D"_blank">Lent.ink</a><br>
0031617012655</div></div></div></div></div></div>

--00000000000026c18f0577f2162c--
</code>

=== Q7. Choose a console mail client that is available in the Ubuntu repositories install it and configure it to read mail for the account added before  ===

CLient chosen: mutt, based on
[[https://www.tecmint.com/best-commandline-email-clients-for-linux/|this]]
knowlegde.

<code>
root@nevers:~/exim# docker-compose start backup
Starting backup ... done
root@nevers:~/exim# docker exec -it exim_backup_1 sh
/ # apk add --no-cache mutt >/dev/null
/ # mutt -f /var/mail/os3student

q:Quit  d:Del  u:Undel  s:Save  m:Mail  r:Reply  g:Group  ?:Help                
   1 N   Oct 11 Sander Lentink  (  20) test                                     
   2 N   Oct 11 Sander Lentink  (  21) test

---Mutt: /var/mail/os3student [Msgs:2 New:2 6.3K]---(date/date)---------(all)---
</code>

== a. Where does the client store read emails?  ==

Exim wrote to /var/mail/USER and mutt prompted the first time,
with the default option of /root/Mail.

== b. In what format?  == 
We have already seen in the previous logs that exim does mbox format by default,
all mails in one file.
Maildir is the current standard, which stores every msg in a seperate file,
which is more efficient when accessing it with multiple clients.
For my own server, I'll use dovecot with Maildir (will set it up after CIA exam).

=== Q8. Briefly explain  ===
== a. what mail queues your mail server uses  ==
During debugging I used 'exim -bpc' to check for messages in the queue.
This is the count variant of '-bp',
which presents a 'mailq' format.
[[https://linux.die.net/man/8/exim|src]]

Exim uses just one queue, it gives a status to a message,
such as frozen.

== b. what is their purpose  ==

The purpose of a queue is to store for processing on a later moment.

== c. where are they located on your machine and  ==
<code>
somehost:/var/spool/exim4# ls -al | tail -2
drwxr-x--- 2 Debian-exim Debian-exim 4861952 Oct 12 08:23 input
drwxr-x--- 2 Debian-exim Debian-exim 2433024 Oct 12 08:23 msglog
somehost:/var/spool/exim4# exim -bpc
466
somehost:/var/spool/exim4# ls input|wc -l
930
somehost:/var/spool/exim4# ls msglog|wc -l
465
</code>

== d. how can you interact with them?  == 

Usually I loop over multiple host,
when a smarthost gets busy:
<code>
cat eximbpc.sh 
#!/bin/bash

mkdir -p /tmp/eximbpc/
for i in `get-hosts|sort|uniq`;
do
  # do not use: -o StrictHostKeyChecking=no
  ssh -q -o PasswordAuthentication=no $i \
  "[[ -f /usr/sbin/exim ]] && echo -n \`hostname\`' ' && exim -bpc" \
  1> /tmp/eximbpc/$i &
done 2> /dev/null
sleep 10
cat /tmp/eximbpc/* | sort -k2 -n
echo 'You can run something like: exim -bp|grep "@"|sort|uniq -c|sort -n'

cat `which get-hosts`
#!/usr/bin/env python3

with open('/etc/hosts') as f:
 for line in f:
   if len(line.split()) > 1 and line[0] != '#':
     hostname = line.split()[1]
     print(hostname)
</code>

So I use the exim CLI.
